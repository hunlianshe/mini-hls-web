"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("../config");
const Base64_1 = require("./Base64");
const utils = require("../utils/utils");
const crypto_1 = require("./crypto");
console.log(config_1.default);
const uploadFile = function (params) {
    if (!params.filePath || params.filePath.length < 9) {
        wx.showModal({
            title: '图片错误',
            content: '请重试',
            showCancel: false,
        });
        return;
    }
    console.log("params.filePath", params.filePath);
    const aliyunFileKey = params.dir;
    const aliyunServerURL = config_1.default.uploadImageUrl;
    const accessid = config_1.default.OSSAccessKeyId;
    const policyBase64 = getPolicyBase64();
    const signature = getSignature(policyBase64);
    wx.uploadFile({
        url: aliyunServerURL,
        filePath: params.filePath,
        name: 'file',
        formData: {
            'key': aliyunFileKey,
            'policy': policyBase64,
            'OSSAccessKeyId': accessid,
            'signature': signature,
            'success_action_status': '200',
        },
        success: function (res) {
            console.log('uploadFile params', params);
            console.log('uploadFile sucess', res);
            if (res.statusCode != 200) {
                if (params.fail) {
                    params.fail(res);
                }
                return;
            }
            if (params.success) {
                console.log('are you coming...');
                params.success(aliyunFileKey);
            }
        },
        fail: function (err) {
            console.log('uploadFile file', err);
            utils.showModal();
            err.wxaddinfo = aliyunServerURL;
            if (params.fail) {
                params.fail(err);
            }
            ;
        },
    });
};
const getPolicyBase64 = function () {
    let date = new Date();
    date.setHours(date.getHours() + config_1.default.timeout);
    let srcT = date.toISOString();
    const policyText = {
        "expiration": srcT,
        "conditions": [
            ["content-length-range", 0, 5 * 1024 * 1024]
        ]
    };
    const policyBase64 = Base64_1.default.encode(JSON.stringify(policyText));
    return policyBase64;
};
const getSignature = function (policyBase64) {
    const accesskey = config_1.default.AccessKeySecret;
    console.log('Crypto.SHA1', crypto_1.default.SHA1);
    const bytes = crypto_1.default.HMAC(crypto_1.default.SHA1, policyBase64, accesskey, {
        asBytes: true
    });
    const signature = crypto_1.default.util.bytesToBase64(bytes);
    return signature;
};
exports.default = uploadFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3NzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3NzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTRCO0FBRTVCLHFDQUErQjtBQUMvQix3Q0FBd0M7QUFJeEMscUNBQThCO0FBRTlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQUcsQ0FBQyxDQUFDO0FBQ2pCLE1BQU0sVUFBVSxHQUFHLFVBQVUsTUFBVTtJQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7UUFDbEQsRUFBRSxDQUFDLFNBQVMsQ0FBQztZQUNYLEtBQUssRUFBRSxNQUFNO1lBQ2IsT0FBTyxFQUFFLEtBQUs7WUFDZCxVQUFVLEVBQUUsS0FBSztTQUNsQixDQUFDLENBQUE7UUFDRixPQUFPO0tBQ1I7SUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMvQyxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ2pDLE1BQU0sZUFBZSxHQUFHLGdCQUFHLENBQUMsY0FBYyxDQUFDO0lBQzNDLE1BQU0sUUFBUSxHQUFHLGdCQUFHLENBQUMsY0FBYyxDQUFDO0lBQ3BDLE1BQU0sWUFBWSxHQUFHLGVBQWUsRUFBRSxDQUFDO0lBQ3ZDLE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUU3QyxFQUFFLENBQUMsVUFBVSxDQUFDO1FBQ1osR0FBRyxFQUFFLGVBQWU7UUFDcEIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxRQUFRO1FBQ3pCLElBQUksRUFBRSxNQUFNO1FBQ1osUUFBUSxFQUFFO1lBRVIsS0FBSyxFQUFFLGFBQWE7WUFDcEIsUUFBUSxFQUFFLFlBQVk7WUFDdEIsZ0JBQWdCLEVBQUUsUUFBUTtZQUMxQixXQUFXLEVBQUUsU0FBUztZQUN0Qix1QkFBdUIsRUFBRSxLQUFLO1NBQy9CO1FBQ0QsT0FBTyxFQUFFLFVBQVUsR0FBRztZQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEMsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsRUFBRTtnQkFDekIsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFO29CQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7aUJBQ2pCO2dCQUNELE9BQU87YUFDUjtZQUNELElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtnQkFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO2dCQUNoQyxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBQy9CO1FBQ0gsQ0FBQztRQUNELElBQUksRUFBRSxVQUFVLEdBQVE7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNwQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDbEIsR0FBRyxDQUFDLFNBQVMsR0FBRyxlQUFlLENBQUM7WUFDaEMsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFO2dCQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7YUFDakI7WUFBQSxDQUFDO1FBQ0osQ0FBQztLQUNGLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQTtBQUVELE1BQU0sZUFBZSxHQUFHO0lBQ3RCLElBQUksSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsZ0JBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM3QyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDOUIsTUFBTSxVQUFVLEdBQUc7UUFDakIsWUFBWSxFQUFFLElBQUk7UUFDbEIsWUFBWSxFQUFFO1lBQ1osQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7U0FDN0M7S0FDRixDQUFDO0lBRUYsTUFBTSxZQUFZLEdBQUcsZ0JBQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQy9ELE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUMsQ0FBQTtBQUVELE1BQU0sWUFBWSxHQUFHLFVBQVUsWUFBZ0I7SUFDN0MsTUFBTSxTQUFTLEdBQUcsZ0JBQUcsQ0FBQyxlQUFlLENBQUM7SUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN2QyxNQUFNLEtBQUssR0FBRyxnQkFBTSxDQUFDLElBQUksQ0FBQyxnQkFBTSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFO1FBQzlELE9BQU8sRUFBRSxJQUFJO0tBQ2QsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxTQUFTLEdBQUcsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRW5ELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUMsQ0FBQTtBQUVELGtCQUFlLFVBQVUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBlbnYgZnJvbSAnLi4vY29uZmlnJztcblxuaW1wb3J0IEJhc2U2NCBmcm9tICAnLi9CYXNlNjQnO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG4vLyByZXF1aXJlKCcuL2htYWMuanMnKTtcbi8vIHJlcXVpcmUoJy4vc2hhMS5qcycpO1xuaW1wb3J0IENyeXB0byBmcm9tICcuL2NyeXB0byc7XG5cbmNvbnNvbGUubG9nKGVudik7XG5jb25zdCB1cGxvYWRGaWxlID0gZnVuY3Rpb24gKHBhcmFtczphbnkpIHtcbiAgaWYgKCFwYXJhbXMuZmlsZVBhdGggfHwgcGFyYW1zLmZpbGVQYXRoLmxlbmd0aCA8IDkpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6ICflm77niYfplJnor68nLFxuICAgICAgY29udGVudDogJ+ivt+mHjeivlScsXG4gICAgICBzaG93Q2FuY2VsOiBmYWxzZSxcbiAgICB9KVxuICAgIHJldHVybjtcbiAgfVxuICBjb25zb2xlLmxvZyhcInBhcmFtcy5maWxlUGF0aFwiLCBwYXJhbXMuZmlsZVBhdGgpXG4gIGNvbnN0IGFsaXl1bkZpbGVLZXkgPSBwYXJhbXMuZGlyO1xuICBjb25zdCBhbGl5dW5TZXJ2ZXJVUkwgPSBlbnYudXBsb2FkSW1hZ2VVcmw7XG4gIGNvbnN0IGFjY2Vzc2lkID0gZW52Lk9TU0FjY2Vzc0tleUlkO1xuICBjb25zdCBwb2xpY3lCYXNlNjQgPSBnZXRQb2xpY3lCYXNlNjQoKTtcbiAgY29uc3Qgc2lnbmF0dXJlID0gZ2V0U2lnbmF0dXJlKHBvbGljeUJhc2U2NCk7XG5cbiAgd3gudXBsb2FkRmlsZSh7XG4gICAgdXJsOiBhbGl5dW5TZXJ2ZXJVUkwsXG4gICAgZmlsZVBhdGg6IHBhcmFtcy5maWxlUGF0aCxcbiAgICBuYW1lOiAnZmlsZScsXG4gICAgZm9ybURhdGE6IHtcbiAgICAgIC8vJ25hbWUnOiBcInBpY3R1cmUucG5nXCIsXG4gICAgICAna2V5JzogYWxpeXVuRmlsZUtleSxcbiAgICAgICdwb2xpY3knOiBwb2xpY3lCYXNlNjQsXG4gICAgICAnT1NTQWNjZXNzS2V5SWQnOiBhY2Nlc3NpZCxcbiAgICAgICdzaWduYXR1cmUnOiBzaWduYXR1cmUsXG4gICAgICAnc3VjY2Vzc19hY3Rpb25fc3RhdHVzJzogJzIwMCcsXG4gICAgfSxcbiAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmVzKSB7XG4gICAgICBjb25zb2xlLmxvZygndXBsb2FkRmlsZSBwYXJhbXMnLCBwYXJhbXMpO1xuICAgICAgY29uc29sZS5sb2coJ3VwbG9hZEZpbGUgc3VjZXNzJywgcmVzKTtcbiAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSAhPSAyMDApIHtcbiAgICAgICAgaWYgKHBhcmFtcy5mYWlsKSB7XG4gICAgICAgICAgcGFyYW1zLmZhaWwocmVzKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChwYXJhbXMuc3VjY2Vzcykge1xuICAgICAgICBjb25zb2xlLmxvZygnYXJlIHlvdSBjb21pbmcuLi4nKVxuICAgICAgICBwYXJhbXMuc3VjY2VzcyhhbGl5dW5GaWxlS2V5KTtcbiAgICAgIH1cbiAgICB9LFxuICAgIGZhaWw6IGZ1bmN0aW9uIChlcnI6IGFueSkge1xuICAgICAgY29uc29sZS5sb2coJ3VwbG9hZEZpbGUgZmlsZScsIGVycik7XG4gICAgICB1dGlscy5zaG93TW9kYWwoKTtcbiAgICAgIGVyci53eGFkZGluZm8gPSBhbGl5dW5TZXJ2ZXJVUkw7XG4gICAgICBpZiAocGFyYW1zLmZhaWwpIHtcbiAgICAgICAgcGFyYW1zLmZhaWwoZXJyKVxuICAgICAgfTtcbiAgICB9LFxuICB9KVxufVxuXG5jb25zdCBnZXRQb2xpY3lCYXNlNjQgPSBmdW5jdGlvbiAoKSB7XG4gIGxldCBkYXRlID0gbmV3IERhdGUoKTtcbiAgZGF0ZS5zZXRIb3VycyhkYXRlLmdldEhvdXJzKCkgKyBlbnYudGltZW91dCk7XG4gIGxldCBzcmNUID0gZGF0ZS50b0lTT1N0cmluZygpO1xuICBjb25zdCBwb2xpY3lUZXh0ID0ge1xuICAgIFwiZXhwaXJhdGlvblwiOiBzcmNULCAvL+iuvue9ruivpVBvbGljeeeahOWkseaViOaXtumXtFxuICAgIFwiY29uZGl0aW9uc1wiOiBbXG4gICAgICBbXCJjb250ZW50LWxlbmd0aC1yYW5nZVwiLCAwLCA1ICogMTAyNCAqIDEwMjRdIC8vIOiuvue9ruS4iuS8oOaWh+S7tueahOWkp+Wwj+mZkOWItiw1bWJcbiAgICBdXG4gIH07XG5cbiAgY29uc3QgcG9saWN5QmFzZTY0ID0gQmFzZTY0LmVuY29kZShKU09OLnN0cmluZ2lmeShwb2xpY3lUZXh0KSk7XG4gIHJldHVybiBwb2xpY3lCYXNlNjQ7XG59XG5cbmNvbnN0IGdldFNpZ25hdHVyZSA9IGZ1bmN0aW9uIChwb2xpY3lCYXNlNjQ6YW55KSB7XG4gIGNvbnN0IGFjY2Vzc2tleSA9IGVudi5BY2Nlc3NLZXlTZWNyZXQ7XG4gIGNvbnNvbGUubG9nKCdDcnlwdG8uU0hBMScsIENyeXB0by5TSEExKVxuICBjb25zdCBieXRlcyA9IENyeXB0by5ITUFDKENyeXB0by5TSEExLCBwb2xpY3lCYXNlNjQsIGFjY2Vzc2tleSwge1xuICAgIGFzQnl0ZXM6IHRydWVcbiAgfSk7XG4gIGNvbnN0IHNpZ25hdHVyZSA9IENyeXB0by51dGlsLmJ5dGVzVG9CYXNlNjQoYnl0ZXMpO1xuXG4gIHJldHVybiBzaWduYXR1cmU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHVwbG9hZEZpbGU7XG4iXX0=