"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const app = getApp();
const Api = require("../../service/api.service");
const config_1 = require("../../config");
const utils_1 = require("../../utils/utils");
Page({
    data: {
        user: { openid: '' },
        group: {},
        currentCity: '',
        selectValue: '',
        cityList: [],
        hotCityList: [],
        popHidden: true,
        hasStorage: false,
        auth: false,
    },
    onLoad: function (options) {
        if (options.auth) {
            this.setData({
                auth: options.auth
            });
        }
        let _this = this;
        wx.getStorageInfo({
            success(res) {
                if (res.keys.indexOf('user') !== -1 &&
                    res.keys.indexOf('currentCity') !== -1 &&
                    res.keys.indexOf('userShopInfo') !== -1 &&
                    !_this.data.auth) {
                    _this.setData({
                        hasStorage: true
                    });
                    setTimeout(() => {
                        wx.switchTab({
                            url: '../home/home',
                        });
                    }, 1500);
                }
                else {
                    _this.getOpenid();
                    if (app.globalData.userLocation) {
                        wx.showLoading({
                            title: '定位中',
                        });
                        wx.getLocation({
                            type: 'wgs84',
                            success(res) {
                                _this.getLocalCity(res.latitude, res.longitude);
                            }
                        });
                    }
                    else {
                        _this.getWeChatCity();
                    }
                }
            }
        });
    },
    getOpenid() {
        let _this = this;
        wx.login({
            success: function (data) {
                Api.getOpenid(data.code).then((result) => {
                    if (result.code === 200) {
                        _this.data.user.openid = result.data.openid;
                        _this.setData({
                            user: _this.data.user
                        });
                    }
                    else {
                    }
                }).catch(() => {
                });
            },
            fail: function (err) {
                console.log('wx.login failed', err);
            }
        });
    },
    getCityList() {
        Api.getCityList({}).then((result) => {
            if (result.code === 200) {
                const cityList = result.data;
                cityList.forEach((e) => {
                    e.data.forEach((city) => {
                        city.name = utils_1.cityReplace(city.name);
                    });
                });
                this.setData({
                    cityList: result.data,
                });
                wx.setStorage({
                    key: 'cityList',
                    data: result.data,
                });
            }
            else { }
        }).catch((err) => {
            console.log('getCityList err', err);
        });
    },
    getHotCityList() {
        Api.getCityList({ hot: 1 }).then((result) => {
            if (result.code === 200) {
                const hotCityList = result.data;
                hotCityList.forEach((e) => {
                    e.name = utils_1.cityReplace(e.name);
                });
                this.setData({
                    hotCityList: result.data,
                });
                wx.setStorage({
                    key: 'hotCityList',
                    data: result.data,
                });
            }
            else { }
        }).catch((err) => {
            console.log('getHotCityList err', err);
        });
    },
    getWeChatCity() {
        let _this = this;
        wx.authorize({
            scope: "scope.userLocation",
            success() {
                wx.showLoading({
                    title: '定位中',
                });
                wx.getLocation({
                    type: 'wgs84',
                    success(res) {
                        app.globalData.userLocation = true;
                        _this.getLocalCity(res.latitude, res.longitude);
                    },
                    fail() {
                        _this.setData({
                            currentCity: "定位失败"
                        });
                    }
                });
            }
        });
    },
    getLocalCity(latitude, longitude) {
        let _this = this;
        wx.request({
            url: 'https://api.map.baidu.com/geocoder/v2/?ak=' + config_1.default.ak + '&location=' + latitude + ',' + longitude + '&output=json',
            data: {},
            header: {
                'Content-Type': 'application/json'
            },
            success: function (res) {
                let city = res.data.result.addressComponent.city;
                city = utils_1.cityReplace(city);
                _this.setData({
                    currentCity: city
                });
                wx.setStorage({
                    key: 'currentCity',
                    data: city,
                });
                wx.hideLoading();
            },
            fail: function () {
                _this.setData({
                    currentCity: "---"
                });
                wx.hideLoading();
            },
        });
    },
    popPicker() {
        let popHidden = this.data.popHidden;
        this.setData({
            popHidden: !popHidden,
        });
    },
    goHome(e) {
        this.getUser(e);
    },
    getUser(e) {
        let userInfo = e.detail.userInfo;
        userInfo.openid = this.data.user.openid;
        if (!userInfo.openid) {
            return;
        }
        Api.insertUser(userInfo).then((result) => {
            if (result.code === 200) {
                userInfo.token = result.data.token;
                wx.setStorage({
                    key: "user",
                    data: userInfo,
                    success: () => {
                        wx.switchTab({
                            url: `../home/home`,
                        });
                    }
                });
            }
        }).catch(() => {
        });
    },
    doSelect(e) {
        if (e.detail.name) {
            this.setData({
                popHidden: true,
                currentCity: e.detail.name,
            });
            wx.setStorage({
                key: 'currentCity',
                data: e.detail.name,
            });
        }
        else {
            this.setData({
                popHidden: true,
            });
        }
    },
    onReady: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBQ3JCLGlEQUFpRDtBQUNqRCx5Q0FBa0M7QUFDbEMsNkNBRTJCO0FBSTNCLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLElBQUksRUFBRSxFQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUM7UUFDbEIsS0FBSyxFQUFFLEVBQUU7UUFDVCxXQUFXLEVBQUUsRUFBRTtRQUNmLFdBQVcsRUFBRSxFQUFFO1FBQ2YsUUFBUSxFQUFFLEVBQUU7UUFDWixXQUFXLEVBQUUsRUFBRTtRQUNmLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLEtBQUs7UUFDakIsSUFBSSxFQUFFLEtBQUs7S0FDWjtJQUVELE1BQU0sRUFBRSxVQUFVLE9BQVc7UUFDM0IsSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxPQUFRLENBQUM7Z0JBQ1osSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO2FBQ25CLENBQUMsQ0FBQTtTQUNIO1FBQ0QsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFDaEIsT0FBTyxDQUFDLEdBQUc7Z0JBQ1QsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ2pDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDdEMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUN2QyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO29CQUNsQixLQUFLLENBQUMsT0FBUSxDQUFDO3dCQUNiLFVBQVUsRUFBRSxJQUFJO3FC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RCxRQUFRLENBQUMsQ0FBTTtRQUNiLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7WUFDakIsSUFBSSxDQUFDLE9BQVEsQ0FBQztnQkFDWixTQUFTLEVBQUUsSUFBSTtnQkFDZixXQUFXLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJO2FBQzNCLENBQUMsQ0FBQTtZQUNGLEVBQUUsQ0FBQyxVQUFVLENBQUM7Z0JBQ1osR0FBRyxFQUFFLGFBQWE7Z0JBQ2xCLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUk7YUFDcEIsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLElBQUksQ0FBQyxPQUFRLENBQUM7Z0JBQ1osU0FBUyxFQUFFLElBQUk7YUFDaEIsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDO0lBRUQsT0FBTyxFQUFFO0lBQ1QsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxuY29uc3QgYXBwID0gZ2V0QXBwKCk7XG5pbXBvcnQgKiBhcyBBcGkgZnJvbSAnLi4vLi4vc2VydmljZS9hcGkuc2VydmljZSc7XG5pbXBvcnQgY29uZmlnIGZyb20gJy4uLy4uL2NvbmZpZyc7XG5pbXBvcnQge1xuICBjaXR5UmVwbGFjZSxcbn0gZnJvbSAnLi4vLi4vdXRpbHMvdXRpbHMnO1xuXG5pbXBvcnQgVXNlciBmcm9tICcuLi8uLi9pbnRlcmZhY2UvdXNlcic7XG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgdXNlcjoge29wZW5pZDogJyd9LFxuICAgIGdyb3VwOiB7fSxcbiAgICBjdXJyZW50Q2l0eTogJycsXG4gICAgc2VsZWN0VmFsdWU6ICcnLFxuICAgIGNpdHlMaXN0OiBbXSxcbiAgICBob3RDaXR5TGlzdDogW10sXG4gICAgcG9wSGlkZGVuOiB0cnVlLFxuICAgIGhhc1N0b3JhZ2U6IGZhbHNlLFxuICAgIGF1dGg6IGZhbHNlLFxuICB9LFxuXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnM6YW55KSB7XG4gICAgaWYgKG9wdGlvbnMuYXV0aCkge1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIGF1dGg6IG9wdGlvbnMuYXV0aFxuICAgICAgfSlcbiAgICB9XG4gICAgbGV0IF90aGlzID0gdGhpcztcbiAgICB3eC5nZXRTdG9yYWdlSW5mbyh7XG4gICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICBpZiAocmVzLmtleXMuaW5kZXhPZigndXNlcicpICE9PSAtMSAmJlxuICAgICAgICAgIHJlcy5rZXlzLmluZGV4T2YoJ2N1cnJlbnRDaXR5JykgIT09IC0xICYmXG4gICAgICAgICAgcmVzLmtleXMuaW5kZXhPZigndXNlclNob3BJbmZvJykgIT09IC0xICYmXG4gICAgICAgICAgIV90aGlzLmRhdGEuYXV0aCkge1xuICAgICAgICAgIF90aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIGhhc1N0b3JhZ2U6IHRydWVcbiAgICAgICAgICB9KVxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgd3guc3dpdGNoVGFiKHtcbiAgICAgICAgICAgICAgdXJsOiAnLi4vaG9tZS9ob21lJyxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSwgMTUwMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgX3RoaXMuZ2V0T3BlbmlkKCk7XG4gICAgICAgICAgLy8gX3RoaXMuZ2V0Q2l0eUxpc3QoKTsgLy8g5pS+5YWl57yT5a2YXG4gICAgICAgICAgLy8gX3RoaXMuZ2V0SG90Q2l0eUxpc3QoKTtcbiAgICAgICAgICBpZiAoYXBwLmdsb2JhbERhdGEudXNlckxvY2F0aW9uKSB7XG4gICAgICAgICAgICB3eC5zaG93TG9hZGluZyh7XG4gICAgICAgICAgICAgIHRpdGxlOiAn5a6a5L2N5LitJyxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB3eC5nZXRMb2NhdGlvbih7XG4gICAgICAgICAgICAgIHR5cGU6ICd3Z3M4NCcsXG4gICAgICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgICAgICAgX3RoaXMuZ2V0TG9jYWxDaXR5KHJlcy5sYXRpdHVkZSwgcmVzLmxvbmdpdHVkZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIF90aGlzLmdldFdlQ2hhdENpdHkoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGdldE9wZW5pZCgpIHtcbiAgICBsZXQgX3RoaXMgPSB0aGlzO1xuICAgIHd4LmxvZ2luKHtcbiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIEFwaS5nZXRPcGVuaWQoZGF0YS5jb2RlKS50aGVuKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICAgIGlmIChyZXN1bHQuY29kZSA9PT0gMjAwKSB7XG4gICAgICAgICAgICBfdGhpcy5kYXRhLnVzZXIub3BlbmlkID0gcmVzdWx0LmRhdGEub3BlbmlkO1xuICAgICAgICAgICAgX3RoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICB1c2VyOiBfdGhpcy5kYXRhLnVzZXJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgfVxuICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgIH0pXG4gICAgICB9LFxuICAgICAgZmFpbDogZnVuY3Rpb24gKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZygnd3gubG9naW4gZmFpbGVkJywgZXJyKVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgLyoqIOiOt+WPluWfjuW4guWIl+ihqCAqL1xuICBnZXRDaXR5TGlzdCgpIHtcbiAgICBBcGkuZ2V0Q2l0eUxpc3Qoe30pLnRoZW4oKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICBpZiAocmVzdWx0LmNvZGUgPT09IDIwMCkge1xuICAgICAgICBjb25zdCBjaXR5TGlzdCA9IHJlc3VsdC5kYXRhO1xuICAgICAgICBjaXR5TGlzdC5mb3JFYWNoKChlOiBhbnkpID0+IHtcbiAgICAgICAgICBlLmRhdGEuZm9yRWFjaCgoY2l0eTogYW55KSA9PiB7XG4gICAgICAgICAgICBjaXR5Lm5hbWUgPSBjaXR5UmVwbGFjZShjaXR5Lm5hbWUpO1xuICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICBjaXR5TGlzdDogcmVzdWx0LmRhdGEsXG4gICAgICAgIH0pO1xuICAgICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAgICBrZXk6ICdjaXR5TGlzdCcsXG4gICAgICAgICAgZGF0YTogcmVzdWx0LmRhdGEsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHsgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdnZXRDaXR5TGlzdCBlcnInLCBlcnIpO1xuICAgIH0pXG4gIH0sXG5cbiAgLyoqIOiOt+WPluWfjuW4guWIl+ihqCAqL1xuICBnZXRIb3RDaXR5TGlzdCgpIHtcbiAgICBBcGkuZ2V0Q2l0eUxpc3Qoe2hvdDogMX0pLnRoZW4oKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICBpZiAocmVzdWx0LmNvZGUgPT09IDIwMCkge1xuICAgICAgICBjb25zdCBob3RDaXR5TGlzdCA9IHJlc3VsdC5kYXRhO1xuICAgICAgICBob3RDaXR5TGlzdC5mb3JFYWNoKChlOmFueSkgPT4ge1xuICAgICAgICAgIGUubmFtZSA9IGNpdHlSZXBsYWNlKGUubmFtZSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICBob3RDaXR5TGlzdDogcmVzdWx0LmRhdGEsXG4gICAgICAgIH0pO1xuICAgICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAgICBrZXk6ICdob3RDaXR5TGlzdCcsXG4gICAgICAgICAgZGF0YTogcmVzdWx0LmRhdGEsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHsgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdnZXRIb3RDaXR5TGlzdCBlcnInLCBlcnIpO1xuICAgIH0pXG4gIH0sXG5cbiAgLyoqIOiOt+WPluWumuS9jSAqL1xuICBnZXRXZUNoYXRDaXR5KCkge1xuICAgIGxldCBfdGhpcyA9IHRoaXNcbiAgICB3eC5hdXRob3JpemUoe1xuICAgICAgc2NvcGU6IFwic2NvcGUudXNlckxvY2F0aW9uXCIsXG4gICAgICBzdWNjZXNzKCkge1xuICAgICAgICB3eC5zaG93TG9hZGluZyh7XG4gICAgICAgICAgdGl0bGU6ICflrprkvY3kuK0nLFxuICAgICAgICB9KVxuICAgICAgICB3eC5nZXRMb2NhdGlvbih7XG4gICAgICAgICAgdHlwZTogJ3dnczg0JyxcbiAgICAgICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckxvY2F0aW9uID0gdHJ1ZTtcbiAgICAgICAgICAgIF90aGlzLmdldExvY2FsQ2l0eShyZXMubGF0aXR1ZGUsIHJlcy5sb25naXR1ZGUpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZmFpbCgpIHtcbiAgICAgICAgICAgIF90aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgY3VycmVudENpdHk6IFwi5a6a5L2N5aSx6LSlXCJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICAvKipcbiAgICog6I635Y+W5a6a5L2N5Z+O5biCXG4gICAqIEBwYXJhbSBsYXRpdHVkZSDnu4/luqZcbiAgICogQHBhcmFtIGxvbmdpdHVkZSDnuqzluqZcbiAgICovXG4gIGdldExvY2FsQ2l0eShsYXRpdHVkZTogYW55LCBsb25naXR1ZGU6IGFueSkge1xuICAgIGxldCBfdGhpcyA9IHRoaXM7XG4gICAgd3gucmVxdWVzdCh7XG4gICAgICB1cmw6ICdodHRwczovL2FwaS5tYXAuYmFpZHUuY29tL2dlb2NvZGVyL3YyLz9haz0nICsgY29uZmlnLmFrICsnJmxvY2F0aW9uPScgKyBsYXRpdHVkZSArICcsJyArIGxvbmdpdHVkZSArICcmb3V0cHV0PWpzb24nLFxuICAgICAgZGF0YToge30sXG4gICAgICBoZWFkZXI6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgfSxcbiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXM6IGFueSkge1xuICAgICAgICBsZXQgY2l0eSA9IHJlcy5kYXRhLnJlc3VsdC5hZGRyZXNzQ29tcG9uZW50LmNpdHk7XG4gICAgICAgIGNpdHkgPSBjaXR5UmVwbGFjZShjaXR5KTtcbiAgICAgICAgX3RoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIGN1cnJlbnRDaXR5OiBjaXR5XG4gICAgICAgIH0pO1xuICAgICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAgICBrZXk6ICdjdXJyZW50Q2l0eScsXG4gICAgICAgICAgZGF0YTogY2l0eSxcbiAgICAgICAgfSk7XG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XG4gICAgICB9LFxuICAgICAgZmFpbDogZnVuY3Rpb24gKCkge1xuICAgICAgICBfdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgY3VycmVudENpdHk6IFwiLS0tXCJcbiAgICAgICAgfSk7XG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XG4gICAgICB9LFxuICAgIH0pXG4gIH0sXG5cbiAgLyoqIOaOp+WItnBpY2tlciAqL1xuICBwb3BQaWNrZXIoKSB7XG4gICAgbGV0IHBvcEhpZGRlbiA9IHRoaXMuZGF0YS5wb3BIaWRkZW47XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBwb3BIaWRkZW46ICFwb3BIaWRkZW4sXG4gICAgfSlcbiAgfSxcblxuICAvKiogXG4gICAqIOiOt+WPluaOiOadg+WSjOeUqOaIt+S/oeaBr1xuICAgKiDliJvlu7rnlKjmiLfvvIjlkI7nq6/liKTmlq3mmK/lkKblt7Lnu4/liJvlu7rvvIlcbiAgICog6Lez6L2s5bm/5Zy6dGFiQmFy6aG1XG4gICAqL1xuICBnb0hvbWUoZTphbnkpIHtcbiAgICB0aGlzLmdldFVzZXIoZSk7XG4gIH0sXG5cbiAgLyoqIOiOt+WPlueUqOaIt+S/oeaBryAqL1xuICBnZXRVc2VyKGU6YW55KSB7XG4gICAgbGV0IHVzZXJJbmZvOiBVc2VyID0gZS5kZXRhaWwudXNlckluZm87XG4gICAgdXNlckluZm8ub3BlbmlkID0gdGhpcy5kYXRhLnVzZXIub3BlbmlkO1xuICAgIGlmICghdXNlckluZm8ub3BlbmlkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIEFwaS5pbnNlcnRVc2VyKHVzZXJJbmZvKS50aGVuKChyZXN1bHQ6YW55KSA9PiB7XG4gICAgICBpZiAocmVzdWx0LmNvZGUgPT09IDIwMCkge1xuICAgICAgICB1c2VySW5mby50b2tlbiA9IHJlc3VsdC5kYXRhLnRva2VuO1xuICAgICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAgICBrZXk6IFwidXNlclwiLFxuICAgICAgICAgIGRhdGE6IHVzZXJJbmZvLFxuICAgICAgICAgIHN1Y2Nlc3M6ICgpID0+IHtcbiAgICAgICAgICAgIHd4LnN3aXRjaFRhYih7XG4gICAgICAgICAgICAgIHVybDogYC4uL2hvbWUvaG9tZWAsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIHRoaXMuZ2V0VXNlclNob3BJbmZvKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqIOmAieaLqeWfjuW4giAqL1xuICBkb1NlbGVjdChlOiBhbnkpIHtcbiAgICBpZiAoZS5kZXRhaWwubmFtZSkge1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIHBvcEhpZGRlbjogdHJ1ZSxcbiAgICAgICAgY3VycmVudENpdHk6IGUuZGV0YWlsLm5hbWUsXG4gICAgICB9KVxuICAgICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICAgIGtleTogJ2N1cnJlbnRDaXR5JyxcbiAgICAgICAgZGF0YTogZS5kZXRhaWwubmFtZSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7ICAvLyDlj5bmtojmjInpkq5cbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBwb3BIaWRkZW46IHRydWUsXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICBvblJlYWR5OiBmdW5jdGlvbiAoKSB7XG4gIH0sXG59KSJdfQ==