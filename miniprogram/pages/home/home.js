"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Api = require("../../service/api.service");
const app = getApp();
Page({
    data: {
        userInfo: {},
        psyTest: [],
        currShopList: [],
        dataAlready: false,
        currentCity: '',
        selectValue: '',
        currentQrcode: '',
        currentPhone: '',
        phone: '',
        popHidden: true,
        pageLoaded: false,
        popWechat: false,
        currentPage: 1,
        pageSize: 10,
        totalCount: 0,
        pullDown: false,
        pullUp: false,
        horoscopeData: {},
    },
    onLoad() {
        let _this = this;
        wx.getStorage({
            key: 'user',
            success: function (res) {
                app.globalData.userInfo = res.data;
                _this.setData({
                    userInfo: res.data,
                });
            },
        });
        this.setData({
            pageLoaded: true,
        });
        this.getPsyList();
    },
    goXzys() {
        wx.navigateTo({
            url: `../xzys/xzys`,
        });
    },
    goXlcsList() {
        wx.navigateTo({
            url: `../xlcsList/xlcsList`,
        });
    },
    doTest(e) {
        wx.navigateTo({
            url: `../xlcsDetail/xlcsDetail?id=${e.currentTarget.dataset.id}`,
        });
    },
    goMatch() {
        wx.navigateTo({
            url: `../matcheXz/matcheXz`,
        });
    },
    getPsyList() {
        Api.getPsyList().then((result) => {
            this.setData({
                psyTest: result.data,
            });
        });
    },
    getHoroscopet(e) {
        const { type } = e.currentTarget.dataset;
        const consName = encodeURIComponent(this.data.userInfo.constellation);
        Api.getHoroscopet(consName, type).then((result) => {
            this.setData({
                horoscopeData: result.data,
            });
        });
    },
    doSearch(e) {
        const keyword = e.detail.value;
        const params = {
            keyword,
            needLoading: '1',
        };
        this.getShopList(params);
        this.setData({
            keyword,
            pullDown: false,
            pullUp: false,
        });
    },
    getShopList(params) {
        const totalCount = this.data.totalCount;
        const pageSize = this.data.pageSize;
        let currentPage = this.data.currentPage;
        const pullDown = this.data.pullDown;
        const pullUp = this.data.pullUp;
        if (pullDown && !pullUp && currentPage > 1) {
            --currentPage;
        }
        else if (!pullDown && pullUp) {
            let totalSize = pageSize * (currentPage + 1);
            if (totalSize > totalCount && currentPage > 1) {
                console.log('total size:', pageSize * (currentPage + 1));
                return;
            }
            ++currentPage;
        }
        else {
            console.log('其他情况，视为重新加载');
            currentPage = 1;
        }
        let p = {
            city: this.data.currentCity,
            currentPage,
            limit: pageSize,
        };
        console.log('Object.assign(p, params): ', Object.assign(p, params));
    },
    popPicker() {
        let popHidden = this.data.popHidden;
        this.setData({
            popHidden: !popHidden,
        });
    },
    doSelect(e) {
        if (e.detail.name) {
            this.setData({
                popHidden: true,
                currentCity: e.detail.name,
                pullDown: false,
                pullUp: false,
                currentPage: 1,
            });
            let params = {
                city: e.detail.name,
                needLoading: '1',
            };
            this.getShopList(params);
            wx.setStorage({
                key: 'currentCity',
                data: e.detail.name,
            });
        }
        else {
            this.setData({
                popHidden: true,
            });
        }
    },
    popWechat(e) {
        const currentQrcode = e.currentTarget.dataset.qrcode;
        const currentPhone = e.currentTarget.dataset.phone;
        this.setData({
            currentQrcode,
            currentPhone,
            popWechat: true
        });
    },
    closeWechat() {
        this.setData({
            popWechat: false
        });
    },
    onReady: function () {
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
        this.setData({
            pullDown: true,
            pullUp: false
        });
        this.getShopList({ needLoading: '1' });
        wx.stopPullDownRefresh();
    },
    onReachBottom: function () {
        this.setData({
            pullDown: false,
            pullUp: true
        });
        this.getShopList({ needLoading: '1' });
    },
    onShareAppMessage: function (options) {
        console.log('onShareAppMessage options', options);
        return {};
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9tZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhvbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBaUQ7QUFFakQsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFVLENBQUM7QUFJN0IsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osUUFBUSxFQUFFLEVBQVM7UUFDbkIsT0FBTyxFQUFFLEVBQUU7UUFDWCxZQUFZLEVBQUUsRUFBRTtRQUNoQixXQUFXLEVBQUUsS0FBSztRQUNsQixXQUFXLEVBQUUsRUFBRTtRQUNmLFdBQVcsRUFBRSxFQUFFO1FBQ2YsYUFBYSxFQUFFLEVBQUU7UUFDakIsWUFBWSxFQUFFLEVBQUU7UUFDaEIsS0FBSyxFQUFFLEVBQUU7UUFDVCxTQUFTLEVBQUUsSUFBSTtRQUNmLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLFdBQVcsRUFBRSxDQUFDO1FBQ2QsUUFBUSxFQUFFLEVBQUU7UUFDWixVQUFVLEVBQUUsQ0FBQztRQUNiLFFBQVEsRUFBRSxLQUFLO1FBQ2YsTUFBTSxFQUFFLEtBQUs7UUFDYixhQUFhLEVBQUUsRUFBZTtLQUMvQjtJQUVELE1BQU07UUFDSixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDakIsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNaLEdBQUcsRUFBRSxNQUFNO1lBQ1gsT0FBTyxFQUFFLFVBQVMsR0FBRztnQkFDbkIsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDbkMsS0FBSyxDQUFDLE9BQVEsQ0FBQztvQkFDYixRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUk7aUJBQ25CLENBQUMsQ0FBQztZQUNMLENBQUM7U0FDRixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsT0FBUSxDQUFDO1lBQ1osVUFBVSxFQUFFLElBQUk7U0FDakIsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLFVBQVUsRUFBRSxD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LENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEFwaSBmcm9tICcuLi8uLi9zZXJ2aWNlL2FwaS5zZXJ2aWNlJztcbmltcG9ydCB7IElNeUFwcCB9IGZyb20gJy4uLy4uL2FwcCc7XG5jb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xuXG5pbXBvcnQgSG9yb3Njb3BlIGZyb20gJy4uLy4uL2ludGVyZmFjZS9ob3Jvc2NvcGUnO1xuXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIHVzZXJJbmZvOiB7fSBhcyBhbnksXG4gICAgcHN5VGVzdDogW10sXG4gICAgY3VyclNob3BMaXN0OiBbXSxcbiAgICBkYXRhQWxyZWFkeTogZmFsc2UsXG4gICAgY3VycmVudENpdHk6ICcnLFxuICAgIHNlbGVjdFZhbHVlOiAnJyxcbiAgICBjdXJyZW50UXJjb2RlOiAnJyxcbiAgICBjdXJyZW50UGhvbmU6ICcnLFxuICAgIHBob25lOiAnJyxcbiAgICBwb3BIaWRkZW46IHRydWUsXG4gICAgcGFnZUxvYWRlZDogZmFsc2UsXG4gICAgcG9wV2VjaGF0OiBmYWxzZSxcbiAgICBjdXJyZW50UGFnZTogMSxcbiAgICBwYWdlU2l6ZTogMTAsXG4gICAgdG90YWxDb3VudDogMCxcbiAgICBwdWxsRG93bjogZmFsc2UsXG4gICAgcHVsbFVwOiBmYWxzZSxcbiAgICBob3Jvc2NvcGVEYXRhOiB7fSBhcyBIb3Jvc2NvcGUsXG4gIH0sXG5cbiAgb25Mb2FkICgpIHtcbiAgICBsZXQgX3RoaXMgPSB0aGlzO1xuICAgIHd4LmdldFN0b3JhZ2Uoe1xuICAgICAga2V5OiAndXNlcicsXG4gICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXMpIHtcbiAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMuZGF0YTtcbiAgICAgICAgX3RoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIHVzZXJJbmZvOiByZXMuZGF0YSxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgcGFnZUxvYWRlZDogdHJ1ZSxcbiAgICB9KVxuICAgIHRoaXMuZ2V0UHN5TGlzdCgpO1xuICB9LFxuICBcbiAgXG4gIC8qKiDmmJ/luqfov5Dlir8gKi9cbiAgZ29YenlzKCkge1xuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiBgLi4veHp5cy94enlzYCxcbiAgICB9KVxuICB9LFxuXG4gIC8qKiDlv4PnkIbmtYvor5XliJfooaggKi9cbiAgZ29YbGNzTGlzdCgpIHtcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogYC4uL3hsY3NMaXN0L3hsY3NMaXN0YCxcbiAgICB9KVxuICB9LFxuICBcbiAgLyoqIOW/g+eQhua1i+ivlSAqL1xuICBkb1Rlc3QoZTogYW55KSB7XG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6IGAuLi94bGNzRGV0YWlsL3hsY3NEZXRhaWw/aWQ9JHtlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pZH1gLFxuICAgIH0pXG4gIH0sXG5cbiAgLyoqIOaYn+W6p+WMuemFjSAqL1xuICBnb01hdGNoKCkge1xuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiBgLi4vbWF0Y2hlWHovbWF0Y2hlWHpgLFxuICAgIH0pXG4gIH0sXG5cbiAgLyoqIOiOt+WPluW/g+eQhua1i+ivlSAqL1xuICBnZXRQc3lMaXN0KCkge1xuICAgIEFwaS5nZXRQc3lMaXN0KCkudGhlbigocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBwc3lUZXN0OiByZXN1bHQuZGF0YSxcbiAgICAgIH0pXG4gICAgfSlcbiAgfSxcblxuICAvKiog6L+Q5Yq/5YiG5p6QICAqL1xuICBnZXRIb3Jvc2NvcGV0KGU6IGFueSkge1xuICAgIGNvbnN0IHsgdHlwZSB9ID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQ7XG4gICAgY29uc3QgY29uc05hbWUgPSBlbmNvZGVVUklDb21wb25lbnQodGhpcy5kYXRhLnVzZXJJbmZvLmNvbnN0ZWxsYXRpb24pXG4gICAgQXBpLmdldEhvcm9zY29wZXQoY29uc05hbWUsIHR5cGUpLnRoZW4oKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgaG9yb3Njb3BlRGF0YTogcmVzdWx0LmRhdGEsXG4gICAgICB9KVxuICAgIH0pO1xuICB9LFxuXG5cbiAgLyoqIOmmlumhteaQnOe0oiAqL1xuICBkb1NlYXJjaChlOiBhbnkpIHtcbiAgICBjb25zdCBrZXl3b3JkID0gZS5kZXRhaWwudmFsdWU7IFxuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIGtleXdvcmQsXG4gICAgICBuZWVkTG9hZGluZzogJzEnLFxuICAgIH1cbiAgICB0aGlzLmdldFNob3BMaXN0KHBhcmFtcyk7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBrZXl3b3JkLFxuICAgICAgcHVsbERvd246IGZhbHNlLFxuICAgICAgcHVsbFVwOiBmYWxzZSxcbiAgICB9KVxuICB9LFxuXG4gIC8qKlxuICAgKiDojrflj5blupfpk7rliJfooagg5YiG6aG15Yqg6L29XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgXG4gICAqL1xuICBnZXRTaG9wTGlzdChwYXJhbXM6IGFueSkge1xuICAgIGNvbnN0IHRvdGFsQ291bnQgPSB0aGlzLmRhdGEudG90YWxDb3VudDtcbiAgICBjb25zdCBwYWdlU2l6ZSA9IHRoaXMuZGF0YS5wYWdlU2l6ZTtcbiAgICBsZXQgY3VycmVudFBhZ2UgPSB0aGlzLmRhdGEuY3VycmVudFBhZ2U7XG4gICAgLy8gbGV0IGxhc3RQYWdlID0gdGhpcy5kYXRhLmN1cnJlbnRQYWdlO1xuICAgIGNvbnN0IHB1bGxEb3duID0gdGhpcy5kYXRhLnB1bGxEb3duO1xuICAgIGNvbnN0IHB1bGxVcCA9IHRoaXMuZGF0YS5wdWxsVXA7XG4gICAgaWYgKHB1bGxEb3duICYmICFwdWxsVXAgJiYgY3VycmVudFBhZ2UgPiAxKSB7IC8vIOS4i+aLieWIhumhteWKoOi9vVxuICAgICAgLS1jdXJyZW50UGFnZTtcbiAgICB9IGVsc2UgaWYgKCFwdWxsRG93biAmJiBwdWxsVXAgKSB7ICAgICAgICAgICAgLy8g5LiK5ouJ5Yqg6L29XG4gICAgICBsZXQgdG90YWxTaXplID0gcGFnZVNpemUgKiAoY3VycmVudFBhZ2UgKyAxKTtcbiAgICAgIGlmICh0b3RhbFNpemUgPiB0b3RhbENvdW50ICYmIGN1cnJlbnRQYWdlID4gMSkgeyBcbiAgICAgICAgY29uc29sZS5sb2coJ3RvdGFsIHNpemU6JywgcGFnZVNpemUgKiAoY3VycmVudFBhZ2UgKyAxKSk7IFxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICArK2N1cnJlbnRQYWdlO1xuICAgIH0gZWxzZSB7ICAvLyDlhbbku5bmg4XlhrXvvIzop4bkuLrph43mlrDliqDovb1cbiAgICAgIGNvbnNvbGUubG9nKCflhbbku5bmg4XlhrXvvIzop4bkuLrph43mlrDliqDovb0nKTtcbiAgICAgIGN1cnJlbnRQYWdlID0gMTtcbiAgICB9XG4gICAgbGV0IHAgPSB7XG4gICAgICAvLyBrZXl3b3JkOiB0aGlzLmRhdGEua2V5d29yZCxcbiAgICAgIGNpdHk6IHRoaXMuZGF0YS5jdXJyZW50Q2l0eSxcbiAgICAgIGN1cnJlbnRQYWdlLFxuICAgICAgbGltaXQ6IHBhZ2VTaXplLFxuICAgIH1cbiAgICBjb25zb2xlLmxvZygnT2JqZWN0LmFzc2lnbihwLCBwYXJhbXMpOiAnLCBPYmplY3QuYXNzaWduKHAsIHBhcmFtcykpO1xuICAgIC8vIEFwaS5nZXRTaG9wTGlzdChPYmplY3QuYXNzaWduKHAsIHBhcmFtcykpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgIC8vICAgaWYgKHJlc3VsdC5jb2RlID09PSAyMDApIHtcbiAgICAvLyAgICAgbGV0IHByZVNob3BMaXN0ID0gbGFzdFBhZ2UgPiAxID8gdGhpcy5kYXRhLmN1cnJTaG9wTGlzdCA6IFtdO1xuICAgIC8vICAgICBsZXQgZGF0YUFscmVhZHkgPSB0cnVlO1xuICAgIC8vICAgICBsZXQgc2hvcExpc3QgPSByZXN1bHQuZGF0YS5yb3dzO1xuICAgIC8vICAgICBsZXQgdG90YWxDb3VudCA9IHJlc3VsdC5kYXRhLmNvdW50O1xuICAgIC8vICAgICBpZiAocHVsbERvd24pIHtcbiAgICAvLyAgICAgICBzaG9wTGlzdCA9IHNob3BMaXN0LmNvbmNhdChwcmVTaG9wTGlzdCk7ICAvLyDmmL7npLrkuIrkuIDpobXmlbDmja7lkozlvZPliY3pobXmlbDmja7vvIjlhbHkuKTpobXvvIlcbiAgICAvLyAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICBzaG9wTGlzdCA9IHByZVNob3BMaXN0LmNvbmNhdChzaG9wTGlzdCk7ICAvLyDmmL7npLrkuIrkuIDpobXmlbDmja7lkozlvZPliY3pobXmlbDmja7vvIjlhbHkuKTpobXvvIlcbiAgICAvLyAgICAgfVxuICAgIC8vICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAvLyAgICAgICBkYXRhQWxyZWFkeSxcbiAgICAvLyAgICAgICBzaG9wTGlzdCxcbiAgICAvLyAgICAgICBjdXJyU2hvcExpc3Q6IHJlc3VsdC5kYXRhLnJvd3MsICAvLyDkv53nlZnlvZPliY3pobXmlbDmja5cbiAgICAvLyAgICAgICB0b3RhbENvdW50LFxuICAgIC8vICAgICAgIGN1cnJlbnRQYWdlLFxuICAgIC8vICAgICB9KTtcbiAgICAvLyAgICAgY29uc29sZS5sb2coc2hvcExpc3QubGVuZ3RoKTtcbiAgICAvLyAgIH1cbiAgICAvLyB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgLy8gICBjb25zb2xlLmxvZygnZ2V0IFNob3AgTGlzdCcsIGVycik7XG4gICAgLy8gfSlcbiAgfSxcblxuICAvKiog5o6n5Yi2cGlja2VyICovXG4gIHBvcFBpY2tlcigpIHtcbiAgICBsZXQgcG9wSGlkZGVuID0gdGhpcy5kYXRhLnBvcEhpZGRlbjtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHBvcEhpZGRlbjogIXBvcEhpZGRlbixcbiAgICB9KVxuICB9LFxuXG4gIC8qKiDpgInmi6nln47luIIgKi9cbiAgZG9TZWxlY3QoZTogYW55KSB7XG4gICAgaWYgKGUuZGV0YWlsLm5hbWUpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBwb3BIaWRkZW46IHRydWUsXG4gICAgICAgIGN1cnJlbnRDaXR5OiBlLmRldGFpbC5uYW1lLFxuICAgICAgICBwdWxsRG93bjogZmFsc2UsXG4gICAgICAgIHB1bGxVcDogZmFsc2UsXG4gICAgICAgIGN1cnJlbnRQYWdlOiAxLCAgICDCoC8vIOabtOaNouWfjuW4glxuICAgICAgfSlcbiAgICAgIGxldCBwYXJhbXMgPSB7XG4gICAgICAgIGNpdHk6IGUuZGV0YWlsLm5hbWUsXG4gICAgICAgIG5lZWRMb2FkaW5nOiAnMScsXG4gICAgICB9XG4gICAgICB0aGlzLmdldFNob3BMaXN0KHBhcmFtcyk7XG4gICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAga2V5OiAnY3VycmVudENpdHknLFxuICAgICAgICBkYXRhOiBlLmRldGFpbC5uYW1lLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHsgIC8vIOWPlua2iOaMiemSrlxuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIHBvcEhpZGRlbjogdHJ1ZSxcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIC8qKiDmiZPlvIDlvq7kv6Hkuoznu7TnoIHlvLnmoYYgKi9cbiAgcG9wV2VjaGF0KGU6IGFueSkge1xuICAgIGNvbnN0IGN1cnJlbnRRcmNvZGUgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5xcmNvZGU7XG4gICAgY29uc3QgY3VycmVudFBob25lID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQucGhvbmU7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBjdXJyZW50UXJjb2RlLFxuICAgICAgY3VycmVudFBob25lLFxuICAgICAgcG9wV2VjaGF0OiB0cnVlXG4gICAgfSlcbiAgfSxcblxuICAvKiog5YWz6Zet5b6u5L+h5LqM57u056CB5by55qGGICovXG4gIGNsb3NlV2VjaGF0KCkge1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgcG9wV2VjaGF0OiBmYWxzZVxuICAgIH0pXG4gIH0sXG5cbiAgb25SZWFkeTogZnVuY3Rpb24gKCkge1xuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG4gICAgLy8gY29uc3QgeyBwYWdlTG9hZGVkIH0gPSB0aGlzLmRhdGE7XG4gICAgLy8gaWYgKHBhZ2VMb2FkZWQpIHtcbiAgICAvLyAgIHRoaXMuZ2V0U2hvcExpc3Qoe30sICcwJyk7XG4gICAgLy8gfVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdoumakOiXj1xuICAgKi9cbiAgb25IaWRlOiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cbiAgICovXG4gIG9uVW5sb2FkOiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICog5LiL5ouJ5Yi35pawXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgcHVsbERvd246IHRydWUsXG4gICAgICBwdWxsVXA6IGZhbHNlXG4gICAgfSk7XG4gICAgdGhpcy5nZXRTaG9wTGlzdCh7IG5lZWRMb2FkaW5nOiAnMScgfSk7XG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpO1xuICB9LFxuXG4gIC8qKlxuICAgKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcbiAgICovXG4gIG9uUmVhY2hCb3R0b206IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHB1bGxEb3duOiBmYWxzZSxcbiAgICAgIHB1bGxVcDogdHJ1ZVxuICAgIH0pO1xuICAgIHRoaXMuZ2V0U2hvcExpc3QoeyBuZWVkTG9hZGluZzogJzEnIH0pO1xuICB9LFxuXG4gIC8qKlxuICAgKiDnlKjmiLfngrnlh7vlj7PkuIrop5LliIbkuqtcbiAgICovXG4gIG9uU2hhcmVBcHBNZXNzYWdlOiBmdW5jdGlvbiAob3B0aW9ucz86IFBhZ2UuSVNoYXJlQXBwTWVzc2FnZU9wdGlvbiB8IHVuZGVmaW5lZCk6IFBhZ2UuSUN1c3RvbVNoYXJlQ29udGVudCB7XG4gICAgY29uc29sZS5sb2coJ29uU2hhcmVBcHBNZXNzYWdlIG9wdGlvbnMnLCBvcHRpb25zKTtcbiAgICByZXR1cm4ge307XG4gIH1cbn0pIl19