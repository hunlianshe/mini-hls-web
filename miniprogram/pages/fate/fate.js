"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Api = require("../../service/api.service");
const utils_1 = require("../../utils/utils");
const topMenuList_1 = require("./topMenuList");
const app = getApp();
Page({
    data: {
        userInfo: {},
        userList: [],
        curruserList: [],
        dataAlready: false,
        currentCity: "",
        selectValue: "",
        currentQrcode: "",
        currentPhone: "",
        phone: "",
        popHidden: true,
        pageLoaded: false,
        popWechat: false,
        currentPage: 1,
        pageSize: 10,
        totalCount: 0,
        pullDown: false,
        pullUp: false,
        showDialog: false,
        topMenuContent: {
            ageArray: topMenuList_1.getAgeMenuList(),
            heightArray: topMenuList_1.getHeightMenuList(),
            salaryArray: ["5千以下", "5千～1万", "1万～2万", "2万～5万", "5万以上"],
        },
        showSelect: false,
        optionType: '',
        selection: '',
    },
    onLoad() {
        let _this = this;
        wx.getStorage({
            key: "user",
            success: function (res) {
                _this.setData({
                    userInfo: res.data,
                });
            },
        });
        this.getUserList({});
        this.setData({
            pageLoaded: true,
        });
    },
    userDetail(e) {
        const { openid } = e.currentTarget.dataset;
        wx.navigateTo({
            url: `../userDetail/userDetail?openid=${openid}`,
        });
    },
    getUserList(params) {
        const { objectId } = params;
        Api.getUserList(params)
            .then((result) => {
            this.setData({
                dataAlready: true,
            });
            if (result.code === 200) {
                let dataList = objectId ? this.data.userList : [];
                dataList = dataList.concat(result.data);
                dataList.map((data) => {
                    if (data.age && !data.age.toString().includes("岁")) {
                        data.age = data.age + "岁";
                    }
                });
                dataList.map((item) => {
                    if (item.photos && item.photos.length === 0) {
                        item.photos.push(item.avatarUrl);
                    }
                    item.intro = [];
                    if (item.age) {
                        item.intro.push(item.age);
                    }
                    if (item.jobGeneral) {
                        item.intro.push(item.jobGeneral);
                    }
                    if (item.jobDetail) {
                        item.intro.push(item.jobDetail);
                    }
                    if (item.education) {
                        item.intro.push(item.education);
                    }
                    item.intro = item.intro.join(" | ");
                });
                const { currentPage } = this.data;
                this.setData({
                    userList: dataList,
                    currentPage: currentPage + 1,
                });
            }
        })
            .catch((err) => {
            console.log("get user List", err);
        });
    },
    goMatch() {
        let rightType = "fateMatch";
        if (utils_1.dealRightIntercept(rightType)) {
            this.setData({
                showDialog: true,
            });
            return;
        }
        utils_1.setRightStorage(rightType);
        let userInfo = app.globalData.userInfo;
        if (userInfo && userInfo.phone) {
            wx.navigateTo({
                url: "../matching/matching",
            });
        }
        else {
            wx.navigateTo({
                url: "../registerXz/registerXz",
            });
        }
    },
    onShow: function () {
        const { pageLoaded } = this.data;
        if (pageLoaded) {
            this.getUserList({});
        }
    },
    onPullDownRefresh: function () { },
    onReachBottom: function () {
        let rightType = "fateWatch";
        const { userList, currentPage, pageSize } = this.data;
        if (currentPage > 2 && utils_1.dealRightIntercept(rightType)) {
            this.setData({
                showDialog: true,
            });
            return;
        }
        utils_1.setRightStorage(rightType, currentPage * pageSize);
        const lastId = userList.length > 0 ? userList[userList.length - 1]._id : "";
        const { optionType, selection } = this.data;
        const params = this.dealWithRequestParameter(optionType, selection);
        params.objectId = lastId;
        this.getUserList(params);
    },
    closeDialog() {
        this.setData({
            showDialog: false,
        });
    },
    openSelect(e) {
        const optionTypedata = e.target.dataset.optionType;
        const { optionType } = this.data;
        if (optionTypedata === optionType) {
            this.setData({
                showSelect: false,
                optionType: '',
            });
            return;
        }
        this.setData({
            showSelect: true,
            optionType: optionTypedata,
        });
    },
    chooseTap(e) {
        const selectionData = e.target.dataset.selection;
        const { selection } = this.data;
        console.log(selection);
        this.setData({
            selection: selectionData === selection ? '' : selectionData,
        });
        const { optionType } = this.data;
        const params = this.dealWithRequestParameter(optionType, selection);
        this.getUserList(params);
    },
    dealWithRequestParameter(optionType, selection) {
        const reqParams = {};
        switch (optionType) {
            case 'ageArray':
                reqParams.age = topMenuList_1.ageMenuList[selection];
                break;
            case 'heightArray':
                reqParams.height = topMenuList_1.heightMenuList[selection];
                break;
            case 'salaryArray':
                reqParams.salary = selection;
                break;
        }
        return reqParams;
    },
    onShareAppMessage: function (options) {
        console.log("onShareAppMessage options", options);
        return {};
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBaUQ7QUFDakQsNkNBQXdFO0FBRXhFLCtDQUE0RjtBQUM1RixNQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztBQUU3QixJQUFJLENBQUM7SUFDSCxJQUFJLEVBQUU7UUFDSixRQUFRLEVBQUUsRUFBRTtRQUNaLFFBQVEsRUFBRSxFQUFXO1FBQ3JCLFlBQVksRUFBRSxFQUFFO1FBQ2hCLFdBQVcsRUFBRSxLQUFLO1FBQ2xCLFdBQVcsRUFBRSxFQUFFO1FBQ2YsV0FBVyxFQUFFLEVBQUU7UUFDZixhQUFhLEVBQUUsRUFBRTtRQUNqQixZQUFZLEVBQUUsRUFBRTtRQUNoQixLQUFLLEVBQUUsRUFBRTtRQUNULFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLEtBQUs7UUFDakIsU0FBUyxFQUFFLEtBQUs7UUFDaEIsV0FBVyxFQUFFLENBQUM7UUFDZCxRQUFRLEVBQUUsRUFBRTtRQUNaLFVBQVUsRUFBRSxDQUFDO1FBQ2IsUUFBUSxFQUFFLEtBQUs7UUFDZixNQUFNLEVBQUUsS0FBSztRQUNiLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLGNBQWMsRUFBRTtZQUNkLFFBQVEsRUFBRSw0QkFBYyxFQUFFO1lBQzFCLFdBQVcsRUFBRSwrQkFBaUIsRUFBRTtZQUNoQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDO1NBQ3pEO1FBQ0QsVUFBVSxFQUFFLEtBQUs7UUFDakIsVUFBVSxFQUFFLEVBQUU7UUFDZCxTQUFTLEVBQUUsRUFBRTtLQUNkO0lBRUQsTUFBTTtRQUNKLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUNqQixFQUFFLENBQUMsVUFBVSxDQUFDO1lBQ1osR0FBRyxFQUFFLE1BQU07WUFDWCxPQUFPLEVBQUUsVUFBVSxHQUFHO2dCQUNwQixLQUFL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T0FBaUQ7UUFFakQsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNsRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBcGkgZnJvbSAnLi4vLi4vc2VydmljZS9hcGkuc2VydmljZSc7XG5pbXBvcnQgeyBkZWFsUmlnaHRJbnRlcmNlcHQsIHNldFJpZ2h0U3RvcmFnZSB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWxzJztcbmltcG9ydCB7IElNeUFwcCB9IGZyb20gJy4uLy4uL2FwcCc7XG5pbXBvcnQge2dldEFnZU1lbnVMaXN0LCBnZXRIZWlnaHRNZW51TGlzdCwgYWdlTWVudUxpc3QsIGhlaWdodE1lbnVMaXN0fSBmcm9tICcuL3RvcE1lbnVMaXN0J1xuY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKTtcblxuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICB1c2VySW5mbzoge30sXG4gICAgdXNlckxpc3Q6IFtdIGFzIGFueVtdLFxuICAgIGN1cnJ1c2VyTGlzdDogW10sXG4gICAgZGF0YUFscmVhZHk6IGZhbHNlLFxuICAgIGN1cnJlbnRDaXR5OiBcIlwiLFxuICAgIHNlbGVjdFZhbHVlOiBcIlwiLFxuICAgIGN1cnJlbnRRcmNvZGU6IFwiXCIsXG4gICAgY3VycmVudFBob25lOiBcIlwiLFxuICAgIHBob25lOiBcIlwiLFxuICAgIHBvcEhpZGRlbjogdHJ1ZSxcbiAgICBwYWdlTG9hZGVkOiBmYWxzZSxcbiAgICBwb3BXZWNoYXQ6IGZhbHNlLFxuICAgIGN1cnJlbnRQYWdlOiAxLFxuICAgIHBhZ2VTaXplOiAxMCwgLy8gZGVmYXVsdFxuICAgIHRvdGFsQ291bnQ6IDAsXG4gICAgcHVsbERvd246IGZhbHNlLFxuICAgIHB1bGxVcDogZmFsc2UsXG4gICAgc2hvd0RpYWxvZzogZmFsc2UsXG4gICAgdG9wTWVudUNvbnRlbnQ6IHtcbiAgICAgIGFnZUFycmF5OiBnZXRBZ2VNZW51TGlzdCgpLFxuICAgICAgaGVpZ2h0QXJyYXk6IGdldEhlaWdodE1lbnVMaXN0KCksXG4gICAgICBzYWxhcnlBcnJheTogW1wiNeWNg+S7peS4i1wiLCBcIjXljYPvvZ4x5LiHXCIsIFwiMeS4h++9njLkuIdcIiwgXCIy5LiH772eNeS4h1wiLCBcIjXkuIfku6XkuIpcIl0sXG4gICAgfSxcbiAgICBzaG93U2VsZWN0OiBmYWxzZSxcbiAgICBvcHRpb25UeXBlOiAnJyxcbiAgICBzZWxlY3Rpb246ICcnLFxuICB9LFxuXG4gIG9uTG9hZCgpIHtcbiAgICBsZXQgX3RoaXMgPSB0aGlzO1xuICAgIHd4LmdldFN0b3JhZ2Uoe1xuICAgICAga2V5OiBcInVzZXJcIixcbiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgX3RoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIHVzZXJJbmZvOiByZXMuZGF0YSxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIHRoaXMuZ2V0VXNlckxpc3Qoe30pO1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgcGFnZUxvYWRlZDogdHJ1ZSxcbiAgICB9KTtcbiAgfSxcblxuICAvKiog6K+m5oOFICovXG4gIHVzZXJEZXRhaWwoZTogYW55KSB7XG4gICAgY29uc3QgeyBvcGVuaWQgfSA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiBgLi4vdXNlckRldGFpbC91c2VyRGV0YWlsP29wZW5pZD0ke29wZW5pZH1gLFxuICAgIH0pO1xuICAgIC8vIHd4Lm5hdmlnYXRlVG8oe1xuICAgIC8vICAgdXJsOiAnLi4vcmVnaXN0ZXJQaG9uZS9yZWdpc3RlclBob25lJyxcbiAgICAvLyB9KVxuICB9LFxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gb2JqZWN0SWRcbiAgICogcGFnZVNpemUg6buY6K6kIDEwXG4gICAqL1xuICBnZXRVc2VyTGlzdChwYXJhbXM6IGFueSkge1xuICAgIC8vIGNvbnN0IHBhcmFtcyA9IHsgb2JqZWN0SWQgfTtcbiAgICBjb25zdCB7IG9iamVjdElkIH0gPSBwYXJhbXM7XG4gICAgQXBpLmdldFVzZXJMaXN0KHBhcmFtcylcbiAgICAgIC50aGVuKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICBkYXRhQWxyZWFkeTogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgaWYgKHJlc3VsdC5jb2RlID09PSAyMDApIHtcbiAgICAgICAgICBsZXQgZGF0YUxpc3QgPSBvYmplY3RJZCA/IHRoaXMuZGF0YS51c2VyTGlzdCA6IFtdO1xuICAgICAgICAgIGRhdGFMaXN0ID0gZGF0YUxpc3QuY29uY2F0KHJlc3VsdC5kYXRhKTtcbiAgICAgICAgICBkYXRhTGlzdC5tYXAoKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChkYXRhLmFnZSAmJiAhZGF0YS5hZ2UudG9TdHJpbmcoKS5pbmNsdWRlcyhcIuWygVwiKSkge1xuICAgICAgICAgICAgICBkYXRhLmFnZSA9IGRhdGEuYWdlICsgXCLlsoFcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBkYXRhTGlzdC5tYXAoKGl0ZW0pID0+IHtcbiAgICAgICAgICAgIGlmIChpdGVtLnBob3RvcyAmJiBpdGVtLnBob3Rvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgaXRlbS5waG90b3MucHVzaChpdGVtLmF2YXRhclVybCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpdGVtLmludHJvID0gW107XG4gICAgICAgICAgICBpZiAoaXRlbS5hZ2UpIHtcbiAgICAgICAgICAgICAgaXRlbS5pbnRyby5wdXNoKGl0ZW0uYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpdGVtLmpvYkdlbmVyYWwpIHtcbiAgICAgICAgICAgICAgaXRlbS5pbnRyby5wdXNoKGl0ZW0uam9iR2VuZXJhbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbS5qb2JEZXRhaWwpIHtcbiAgICAgICAgICAgICAgaXRlbS5pbnRyby5wdXNoKGl0ZW0uam9iRGV0YWlsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpdGVtLmVkdWNhdGlvbikge1xuICAgICAgICAgICAgICBpdGVtLmludHJvLnB1c2goaXRlbS5lZHVjYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaXRlbS5pbnRybyA9IGl0ZW0uaW50cm8uam9pbihcIiB8IFwiKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCB7IGN1cnJlbnRQYWdlIH0gPSB0aGlzLmRhdGE7XG4gICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICB1c2VyTGlzdDogZGF0YUxpc3QsXG4gICAgICAgICAgICBjdXJyZW50UGFnZTogY3VycmVudFBhZ2UgKyAxLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJnZXQgdXNlciBMaXN0XCIsIGVycik7XG4gICAgICB9KTtcbiAgfSxcblxuICBnb01hdGNoKCkge1xuICAgIGxldCByaWdodFR5cGUgPSBcImZhdGVNYXRjaFwiOyAvLyDnvJjliIbljLnphY1cbiAgICBpZiAoZGVhbFJpZ2h0SW50ZXJjZXB0KHJpZ2h0VHlwZSkpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBzaG93RGlhbG9nOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHNldFJpZ2h0U3RvcmFnZShyaWdodFR5cGUpO1xuXG4gICAgbGV0IHVzZXJJbmZvID0gYXBwLmdsb2JhbERhdGEudXNlckluZm87XG4gICAgaWYgKHVzZXJJbmZvICYmIHVzZXJJbmZvLnBob25lKSB7XG4gICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgdXJsOiBcIi4uL21hdGNoaW5nL21hdGNoaW5nXCIsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgIHVybDogXCIuLi9yZWdpc3Rlclh6L3JlZ2lzdGVyWHpcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcblxuICBvblNob3c6IGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCB7IHBhZ2VMb2FkZWQgfSA9IHRoaXMuZGF0YTtcbiAgICBpZiAocGFnZUxvYWRlZCkge1xuICAgICAgdGhpcy5nZXRVc2VyTGlzdCh7fSk7XG4gICAgfVxuICB9LFxuXG4gIG9uUHVsbERvd25SZWZyZXNoOiBmdW5jdGlvbiAoKSB7fSxcblxuICAvKipcbiAgICog6aG16Z2i5LiK5ouJ6Kem5bqV5LqL5Lu255qE5aSE55CG5Ye95pWwXG4gICAqL1xuICBvblJlYWNoQm90dG9tOiBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHJpZ2h0VHlwZSA9IFwiZmF0ZVdhdGNoXCI7IC8vIOe8mOWIhuS4i+a7keafpeeci+mZkOWItlxuICAgIGNvbnN0IHsgdXNlckxpc3QsIGN1cnJlbnRQYWdlLCBwYWdlU2l6ZSB9ID0gdGhpcy5kYXRhO1xuICAgIGlmIChjdXJyZW50UGFnZSA+IDIgJiYgZGVhbFJpZ2h0SW50ZXJjZXB0KHJpZ2h0VHlwZSkpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBzaG93RGlhbG9nOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHNldFJpZ2h0U3RvcmFnZShyaWdodFR5cGUsIGN1cnJlbnRQYWdlICogcGFnZVNpemUpO1xuICAgIGNvbnN0IGxhc3RJZCA9IHVzZXJMaXN0Lmxlbmd0aCA+IDAgPyB1c2VyTGlzdFt1c2VyTGlzdC5sZW5ndGggLSAxXS5faWQgOiBcIlwiO1xuICAgIFxuICAgIGNvbnN0IHsgb3B0aW9uVHlwZSwgc2VsZWN0aW9uIH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5kZWFsV2l0aFJlcXVlc3RQYXJhbWV0ZXIob3B0aW9uVHlwZSwgc2VsZWN0aW9uKTtcbiAgICBwYXJhbXMub2JqZWN0SWQgPSBsYXN0SWQ7XG4gICAgdGhpcy5nZXRVc2VyTGlzdChwYXJhbXMpO1xuICB9LFxuXG4gIGNsb3NlRGlhbG9nKCkge1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgc2hvd0RpYWxvZzogZmFsc2UsXG4gICAgfSk7XG4gIH0sXG5cbiAgLy8gdHlwZTogYWdlQXJyYXksIGhlaWdodEFycmF5LCBzYWxhcnlBcnJheVxuICBvcGVuU2VsZWN0KGU6IGFueSkge1xuICAgIGNvbnN0IG9wdGlvblR5cGVkYXRhID0gZS50YXJnZXQuZGF0YXNldC5vcHRpb25UeXBlO1xuICAgIGNvbnN0IHsgb3B0aW9uVHlwZSB9ID0gdGhpcy5kYXRhO1xuICAgIGlmIChvcHRpb25UeXBlZGF0YSA9PT0gb3B0aW9uVHlwZSkge1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIHNob3dTZWxlY3Q6IGZhbHNlLFxuICAgICAgICBvcHRpb25UeXBlOiAnJyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHNob3dTZWxlY3Q6IHRydWUsXG4gICAgICBvcHRpb25UeXBlOiBvcHRpb25UeXBlZGF0YSxcbiAgICB9KTtcbiAgfSxcblxuICBjaG9vc2VUYXAoZTogYW55KSB7XG4gICAgY29uc3Qgc2VsZWN0aW9uRGF0YSA9IGUudGFyZ2V0LmRhdGFzZXQuc2VsZWN0aW9uO1xuICAgIGNvbnN0IHsgc2VsZWN0aW9uIH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc29sZS5sb2coc2VsZWN0aW9uKTtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHNlbGVjdGlvbjogc2VsZWN0aW9uRGF0YSA9PT0gc2VsZWN0aW9uID8gJycgOiBzZWxlY3Rpb25EYXRhLFxuICAgIH0pO1xuICAgIGNvbnN0IHsgb3B0aW9uVHlwZSB9ID0gdGhpcy5kYXRhO1xuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZGVhbFdpdGhSZXF1ZXN0UGFyYW1ldGVyKG9wdGlvblR5cGUsIHNlbGVjdGlvbik7XG4gICAgdGhpcy5nZXRVc2VyTGlzdChwYXJhbXMpO1xuICB9LFxuXG4gIC8qXG4gICAg5qC55o2u6YCJ5oup55qE5bm06b6ELCDouqvpq5gsIOaUtuWFpeiMg+WbtCwg6L2s5o2i5oiQ5a+55bqU6K+35rGC5Y+C5pWwXG4gICAgVG9EbzpcbiAgICAgIOmhtemdouS4iuW5tOm+hCwg6Lqr6auYLCDmlLblhaXojIPlm7TpgInmi6lcbiAgKi9cbiAgZGVhbFdpdGhSZXF1ZXN0UGFyYW1ldGVyKG9wdGlvblR5cGU6IHN0cmluZywgc2VsZWN0aW9uOiBzdHJpbmcpIHtcbiAgICAvLyBnZXQgc2VsZWN0T3B0aW9ucyBmcm9tIHRoaXMuZGF0YVxuICAgIC8vIGNvbnN0IGFnZVNlbGVjdGlvbiA9IFwiXCI7XG4gICAgLy8gY29uc3QgaGVpZ2h0U2VsZWN0aW9uID0gXCJcIjtcbiAgICAvLyBjb25zdCBzYWxhcnlTZWxlY3Rpb24gPSBcIlwiO1xuICAgIGNvbnN0IHJlcVBhcmFtczogYW55ID0ge307XG4gICAgLy8gYWdlQXJyYXksIGhlaWdodEFycmF5LCBzYWxhcnlBcnJheVxuICAgIHN3aXRjaChvcHRpb25UeXBlKSB7XG4gICAgICBjYXNlICdhZ2VBcnJheSc6XG4gICAgICAgIHJlcVBhcmFtcy5hZ2UgPSBhZ2VNZW51TGlzdFtzZWxlY3Rpb25dO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2hlaWdodEFycmF5JzpcbiAgICAgICAgcmVxUGFyYW1zLmhlaWdodCA9IGhlaWdodE1lbnVMaXN0W3NlbGVjdGlvbl1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzYWxhcnlBcnJheSc6XG4gICAgICAgIHJlcVBhcmFtcy5zYWxhcnkgPSBzZWxlY3Rpb247XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gcmVxUGFyYW1zO1xuICB9LFxuXG4gIC8qKlxuICAgKiDnlKjmiLfngrnlh7vlj7PkuIrop5LliIbkuqtcbiAgICovXG4gIG9uU2hhcmVBcHBNZXNzYWdlOiBmdW5jdGlvbiAoXG4gICAgb3B0aW9ucz86IFBhZ2UuSVNoYXJlQXBwTWVzc2FnZU9wdGlvbiB8IHVuZGVmaW5lZFxuICApOiBQYWdlLklDdXN0b21TaGFyZUNvbnRlbnQge1xuICAgIGNvbnNvbGUubG9nKFwib25TaGFyZUFwcE1lc3NhZ2Ugb3B0aW9uc1wiLCBvcHRpb25zKTtcbiAgICByZXR1cm4ge307XG4gIH0sXG59KTsiXX0=