"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const socket_service2_1 = require("../../service/socket.service2");
const utils_1 = require("../../utils/utils");
const Api = require("../../service/api.service");
const ChatService = require("../../service/chat.service");
Page({
    data: {
        openid: '',
        cid: '',
        me: {},
        host: '',
        toUser: {},
        userInfo: {},
        message: '',
        pagination: { pageSize: 10, pageToken: '' },
        messageList: [],
        needToView: true,
        inputFocus: true,
    },
    onLoad: function (options) {
        let openid = options.openid;
        let cid = options.cid;
        this.setData({
            cid: cid,
            openid: openid,
        });
        const user = wx.getStorageSync('user');
        this.setData({
            me: user
        });
        this.readAllMessage();
        this.getToUserInfo(openid);
        const { pagination } = this.data;
        this.getMessageList(pagination.pageSize, pagination.pageToken);
        this.receiveMessage();
    },
    readAllMessage() {
        ChatService.updateMsgToReadStatus(this.data.cid);
    },
    getOpenid() {
        let openid = '';
        const user = wx.getStorageSync('user');
        openid = user.openid || '';
        return openid;
    },
    receiveMessage() {
        function getRandom(num) {
            return Math.floor((Math.random() + Math.floor(Math.random() * 9 + 1)) * Math.pow(10, num - 1));
        }
        console.log("准备接收消息");
        let socket = socket_service2_1.getSocket();
        socket.on("privateChat", (msg) => {
            console.log("接收到的消息是", msg);
            var messageList = this.data.messageList;
            console.log("getRandom(10)", getRandom(10));
            msg._id = getRandom(10);
            messageList.push(msg);
            console.log("`item${messageList.length}`", messageList.length);
            this.setData({ messageList });
            let toLast = `item${messageList.length}`;
            console.log('toLast', toLast);
            this.setData({
                scrollTop: 1000 * messageList.length
            });
        });
    },
    getToUserInfo(openid) {
        Api.getUserInfo(openid).then((result) => {
            if (result) {
                const userInfo = result.data;
                this.setData({
                    toUser: userInfo
                });
            }
            else {
                throw new Error("获取用户信息失败");
            }
        });
    },
    sendTap() {
        if (!this.data.message)
            return;
        this.setData({
            needToView: true,
        });
        socket_service2_1.sendMessage({ cid: this.data.cid, msg: this.data.message, type: 1 });
        this.setData({
            msg: ''
        });
        this.setChatSession();
    },
    setChatSession() {
        let chatSession = wx.getStorageSync('chatSession');
        let dateNow = new Date();
        if (chatSession && chatSession.updateTime && new Date(chatSession.updateTime).toDateString() == dateNow.toDateString()) {
            if (chatSession.openidList && chatSession.openidList.length > 0) {
                const index = chatSession.openidList.findIndex((openid) => openid === this.data.openid);
                if (index !== -1) {
                    return;
                }
                else {
                    chatSession.openidList.push(this.data.openid);
                    chatSession = {
                        updateTime: dateNow,
                        openidList: chatSession.openidList,
                    };
                }
            }
        }
        else {
            chatSession = {
                updateTime: dateNow,
                openidList: [this.data.openid]
            };
        }
        wx.setStorageSync("chatSession", chatSession);
    },
    inputTap(e) {
        this.setData({
            message: e.detail.detail.value
        });
    },
    inputBlur() {
        console.log('inputBlurinputBlurinputBlur');
        this.setData({
            inputFocus: false,
        });
    },
    inputFocus() {
        console.log('inputFocus');
        this.setData({
            inputFocus: true,
        });
    },
    uploadImage(e) {
        this.setData({
            needToView: true,
        });
        socket_service2_1.sendMessage({ cid: this.data.cid, msg: e.detail, type: 2 });
    },
    getMessageList(pageSize, pageToken) {
        wx.showLoading({ title: '' });
        Api.getMessageByCid(this.data.cid, pageSize, pageToken).then((result) => {
            let resultList = result.data.result;
            let lastId = result.data.nextPageToken;
            this.setData({
                pagination: {
                    pageToken: lastId,
                    pageSize: 10
                }
            });
            const dateAry = [];
            resultList = resultList.reverse();
            let { messageList } = this.data;
            messageList = resultList.concat(messageList);
            messageList.map((item) => {
                const date = utils_1.getDate(item.createdAt);
                if (dateAry.indexOf(date) == -1) {
                    item.date = date;
                    dateAry.push(date);
                }
                else {
                    item.date = '';
                }
                item.time = utils_1.getTime(item.createdAt);
                return item;
            });
            this.setData({
                messageList
            });
            wx.hideLoading();
        });
    },
    onRefresh: function (e) {
        console.log('onRefresh', e);
        console.log('onRefresh', e.detail.scrollTop);
        const { pagination } = this.data;
        if (e.detail.scrollTop === 0 && pagination.pageToken !== '') {
            this.setData({
                needToView: false,
            });
            this.getMessageList(pagination.pageSize, pagination.pageToken);
        }
    },
    onReady: function () {
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
        ChatService.updateMsgToReadStatus(this.data.cid);
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNoYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxtRUFBc0U7QUFDdEUsNkNBQXFEO0FBQ3JELGlEQUFpRDtBQUNqRCwwREFBMEQ7QUFFMUQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLEVBQUU7UUFDVixHQUFHLEVBQUUsRUFBRTtRQUNQLEVBQUUsRUFBRSxFQUFFO1FBQ04sSUFBSSxFQUFFLEVBQUU7UUFDUixNQUFNLEVBQUUsRUFBRTtRQUNWLFFBQVEsRUFBRSxFQUFFO1FBQ1osT0FBTyxFQUFFLEVBQUU7UUFDWCxVQUFVLEVBQUUsRUFBQyxRQUFRLEVBQUcsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUM7UUFDMUMsV0FBVyxFQUFFLEVBQUU7UUFDZixVQUFVLEVBQUUsSUFBSTtRQUNoQixVQUFVLEVBQUUsSUFBSTtLQUNqQjtJQUVELE1BQU0sRUFBRSxVQUFVLE9BQVc7UUFFM0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM1QixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDWixHQUFHLEVBQUUsR0FBRztZQUNSLE1BQU0sRUFBRSxNQUFNO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsT0FBUSxDQUFDO1lBQ1osRUFBRSxFQUFFLElBQUk7U0FDVCxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQixNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUs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LENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQzVDLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEtBQUssQ0FBQyxJQUFJLFVBQVUsQ0FBQyxTQUFTLEtBQUssRUFBRSxFQUFFO1lBQzNELElBQUksQ0FBQyxPQUFRLENBQUM7Z0JBQ1osVUFBVSxFQUFFLEtBQUs7YUFDbEIsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNoRTtJQUNILENBQUM7SUFLRCxPQUFPLEVBQUU7SUFFVCxDQUFDO0lBS0QsTUFBTSxFQUFFO0lBRVIsQ0FBQztJQUtELE1BQU0sRUFBRTtJQUNSLENBQUM7SUFLRCxRQUFRLEVBQUU7UUFDUixXQUFXLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBS0QsaUJBQWlCLEVBQUU7SUFDbkIsQ0FBQztJQUtELGFBQWEsRUFBRTtJQUNmLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2dldFNvY2tldCwgc2VuZE1lc3NhZ2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlL3NvY2tldC5zZXJ2aWNlMic7XG5pbXBvcnQgeyBnZXREYXRlLCBnZXRUaW1lIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXRpbHMnO1xuaW1wb3J0ICogYXMgQXBpIGZyb20gJy4uLy4uL3NlcnZpY2UvYXBpLnNlcnZpY2UnO1xuaW1wb3J0ICogYXMgQ2hhdFNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZS9jaGF0LnNlcnZpY2UnO1xuXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIG9wZW5pZDogJycsIC8vIOaUtuS/oeS6uueahG9wZW5pZFxuICAgIGNpZDogJycsXG4gICAgbWU6IHt9LCAvLyDmiJHnmoTnlKjmiLfkv6Hmga9cbiAgICBob3N0OiAnJywgLy8g5oiR55qE55So5oi35L+h5oGvXG4gICAgdG9Vc2VyOiB7fSwgLy8g5o6l5pS25Lq655qE55So5oi35L+h5oGvXG4gICAgdXNlckluZm86IHt9LCAvLyDnlKjmiLfkv6Hmga9cbiAgICBtZXNzYWdlOiAnJywgIC8vIOeUqOaIt+i+k+WFpeeahOa2iOaBr1xuICAgIHBhZ2luYXRpb246IHtwYWdlU2l6ZSA6IDEwLCBwYWdlVG9rZW46ICcnfSxcbiAgICBtZXNzYWdlTGlzdDogW10sXG4gICAgbmVlZFRvVmlldzogdHJ1ZSxcbiAgICBpbnB1dEZvY3VzOiB0cnVlLFxuICB9LFxuXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnM6YW55KSB7XG4gICAgLy8gdGhpcy5nZXRVc2VySW5mbygpO1xuICAgIGxldCBvcGVuaWQgPSBvcHRpb25zLm9wZW5pZDtcbiAgICBsZXQgY2lkID0gb3B0aW9ucy5jaWQ7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBjaWQ6IGNpZCxcbiAgICAgIG9wZW5pZDogb3BlbmlkLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdXNlciA9IHd4LmdldFN0b3JhZ2VTeW5jKCd1c2VyJyk7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBtZTogdXNlclxuICAgIH0pO1xuICAgIHRoaXMucmVhZEFsbE1lc3NhZ2UoKTtcblxuICAgIHRoaXMuZ2V0VG9Vc2VySW5mbyhvcGVuaWQpO1xuICAgIGNvbnN0IHsgcGFnaW5hdGlvbiB9ID0gdGhpcy5kYXRhO1xuICAgIHRoaXMuZ2V0TWVzc2FnZUxpc3QocGFnaW5hdGlvbi5wYWdlU2l6ZSwgcGFnaW5hdGlvbi5wYWdlVG9rZW4pO1xuICAgIHRoaXMucmVjZWl2ZU1lc3NhZ2UoKTtcbiAgfSxcblxuICAvLyDorr7nva7mtojmga/lt7Lor7tcbiAgcmVhZEFsbE1lc3NhZ2UoKSB7XG4gICAgQ2hhdFNlcnZpY2UudXBkYXRlTXNnVG9SZWFkU3RhdHVzKHRoaXMuZGF0YS5jaWQpO1xuICB9LFxuXG4gIGdldE9wZW5pZCgpIHtcbiAgICBsZXQgb3BlbmlkOiBzdHJpbmcgPSAnJztcbiAgICBjb25zdCB1c2VyID0gd3guZ2V0U3RvcmFnZVN5bmMoJ3VzZXInKTtcbiAgICBvcGVuaWQgPSB1c2VyLm9wZW5pZCB8fCAnJztcbiAgICByZXR1cm4gb3BlbmlkO1xuICB9LFxuXG4gIHJlY2VpdmVNZXNzYWdlKCkge1xuICAgIGZ1bmN0aW9uIGdldFJhbmRvbShudW06IGFueSl7XG4gICAgICByZXR1cm4gTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKStNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqOSsxKSkqTWF0aC5wb3coMTAsbnVtLTEpKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coXCLlh4blpIfmjqXmlLbmtojmga9cIilcbiAgICBsZXQgc29ja2V0ID0gZ2V0U29ja2V0KClcbiAgICBzb2NrZXQub24oXCJwcml2YXRlQ2hhdFwiLCAobXNnOmFueSkgPT4ge1xuICAgICAgY29uc29sZS5sb2coXCLmjqXmlLbliLDnmoTmtojmga/mmK9cIixtc2cpXG4gICAgICB2YXIgbWVzc2FnZUxpc3Q6IGFueSA9IHRoaXMuZGF0YS5tZXNzYWdlTGlzdDtcbiAgICAgIGNvbnNvbGUubG9nKFwiZ2V0UmFuZG9tKDEwKVwiLGdldFJhbmRvbSgxMCkpO1xuICAgICAgbXNnLl9pZCA9IGdldFJhbmRvbSgxMClcbiAgICAgIG1lc3NhZ2VMaXN0LnB1c2gobXNnKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiYGl0ZW0ke21lc3NhZ2VMaXN0Lmxlbmd0aH1gXCIsbWVzc2FnZUxpc3QubGVuZ3RoKVxuICAgICAgdGhpcy5zZXREYXRhISh7bWVzc2FnZUxpc3R9KVxuICAgICAgbGV0IHRvTGFzdCA9IGBpdGVtJHttZXNzYWdlTGlzdC5sZW5ndGh9YFxuICAgICAgY29uc29sZS5sb2coJ3RvTGFzdCcsdG9MYXN0KVxuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIHNjcm9sbFRvcDogMTAwMCAqIG1lc3NhZ2VMaXN0Lmxlbmd0aCAgLy8g6L+Z6YeM5oiR5Lus55qE5Y2V5a+56K+d5Yy65Z+f5pyA6auYMTAwMO+8jOWPluS6huacgOWkp+WAvO+8jOW6lOivpeacieaWueazleWPluWIsOeyvuehrueahFxuICAgICAgfSk7XG4gICAgfSlcbiAgfSxcblxuICAvLyDmtojmga/lr7nmlrnnmoTkv6Hmga9cbiAgZ2V0VG9Vc2VySW5mbyhvcGVuaWQ6IHN0cmluZykge1xuICAgIEFwaS5nZXRVc2VySW5mbyhvcGVuaWQpLnRoZW4oKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIGNvbnN0IHVzZXJJbmZvID0gcmVzdWx0LmRhdGE7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIHRvVXNlcjogdXNlckluZm9cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCLojrflj5bnlKjmiLfkv6Hmga/lpLHotKVcIik7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqIOWPkemAgea2iOaBr+S6i+S7tiAqL1xuICBzZW5kVGFwKCkge1xuICAgIGlmKCF0aGlzLmRhdGEubWVzc2FnZSkgcmV0dXJuIFxuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgbmVlZFRvVmlldzogdHJ1ZSxcbiAgICB9KTtcbiAgICBzZW5kTWVzc2FnZSh7Y2lkOiB0aGlzLmRhdGEuY2lkLCBtc2c6IHRoaXMuZGF0YS5tZXNzYWdlLCB0eXBlOiAxfSk7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBtc2c6ICcnXG4gICAgfSk7XG4gICAgdGhpcy5zZXRDaGF0U2Vzc2lvbigpO1xuICB9LFxuXG4gIHNldENoYXRTZXNzaW9uKCkge1xuICAgIGxldCBjaGF0U2Vzc2lvbiA9IHd4LmdldFN0b3JhZ2VTeW5jKCdjaGF0U2Vzc2lvbicpO1xuICAgIGxldCBkYXRlTm93ID0gbmV3IERhdGUoKTtcbiAgICAvLyDliKTmlq3mmK/lkKbmmK/lkIzkuIDlpKlcbiAgICBpZiAoY2hhdFNlc3Npb24gJiYgY2hhdFNlc3Npb24udXBkYXRlVGltZSAmJiBuZXcgRGF0ZShjaGF0U2Vzc2lvbi51cGRhdGVUaW1lKS50b0RhdGVTdHJpbmcoKSA9PSBkYXRlTm93LnRvRGF0ZVN0cmluZygpKSB7XG4gICAgICAvLyDljrvph43lkI7lrZjlhaXogYrlpKnkurrliJfooahcbiAgICAgIGlmIChjaGF0U2Vzc2lvbi5vcGVuaWRMaXN0ICYmIGNoYXRTZXNzaW9uLm9wZW5pZExpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBpbmRleCA9IGNoYXRTZXNzaW9uLm9wZW5pZExpc3QuZmluZEluZGV4KChvcGVuaWQ6IGFueSkgPT4gb3BlbmlkID09PSB0aGlzLmRhdGEub3BlbmlkKVxuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNoYXRTZXNzaW9uLm9wZW5pZExpc3QucHVzaCh0aGlzLmRhdGEub3BlbmlkKTtcbiAgICAgICAgICBjaGF0U2Vzc2lvbiA9IHtcbiAgICAgICAgICAgIHVwZGF0ZVRpbWU6IGRhdGVOb3csXG4gICAgICAgICAgICBvcGVuaWRMaXN0OiBjaGF0U2Vzc2lvbi5vcGVuaWRMaXN0LFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjaGF0U2Vzc2lvbiA9IHtcbiAgICAgICAgdXBkYXRlVGltZTogZGF0ZU5vdyxcbiAgICAgICAgb3BlbmlkTGlzdDogW3RoaXMuZGF0YS5vcGVuaWRdXG4gICAgICB9XG4gICAgfVxuICAgIHd4LnNldFN0b3JhZ2VTeW5jKFwiY2hhdFNlc3Npb25cIiwgY2hhdFNlc3Npb24pO1xuICB9LFxuXG4gIC8qKiDovpPlhaXmtojmga/lhoXlrrkgKi9cbiAgaW5wdXRUYXAoZTogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBtZXNzYWdlOiBlLmRldGFpbC5kZXRhaWwudmFsdWUgLy8g6I635Y+W6L6T5YWl55qE5YC8XG4gICAgfSlcbiAgfSxcblxuICBpbnB1dEJsdXIoKSB7XG4gICAgY29uc29sZS5sb2coJ2lucHV0Qmx1cmlucHV0Qmx1cmlucHV0Qmx1cicpXG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBpbnB1dEZvY3VzOiBmYWxzZSxcbiAgICB9KTtcbiAgfSxcblxuICBpbnB1dEZvY3VzKCkge1xuICAgIGNvbnNvbGUubG9nKCdpbnB1dEZvY3VzJylcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIGlucHV0Rm9jdXM6IHRydWUsXG4gICAgfSk7XG4gIH0sXG5cbiAgIC8qKiDovpPlhaXmtojmga/lhoXlrrkgKi9cbiAgIHVwbG9hZEltYWdlKGU6IGFueSkge1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgbmVlZFRvVmlldzogdHJ1ZSxcbiAgICB9KTtcbiAgICBzZW5kTWVzc2FnZSh7Y2lkOiB0aGlzLmRhdGEuY2lkLCBtc2c6IGUuZGV0YWlsLCB0eXBlOiAyfSlcbiAgfSxcblxuICBnZXRNZXNzYWdlTGlzdChwYWdlU2l6ZTogbnVtYmVyLCBwYWdlVG9rZW46IHN0cmluZykge1xuICAgIHd4LnNob3dMb2FkaW5nKHt0aXRsZTogJyd9KTtcbiAgICBBcGkuZ2V0TWVzc2FnZUJ5Q2lkKHRoaXMuZGF0YS5jaWQsIHBhZ2VTaXplLCBwYWdlVG9rZW4pLnRoZW4oKHJlc3VsdDphbnkpID0+IHtcbiAgICAgIGxldCByZXN1bHRMaXN0ID0gcmVzdWx0LmRhdGEucmVzdWx0O1xuICAgICAgbGV0IGxhc3RJZCA9IHJlc3VsdC5kYXRhLm5leHRQYWdlVG9rZW47XG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgIHBhZ2VUb2tlbjogbGFzdElkLFxuICAgICAgICAgIHBhZ2VTaXplOiAxMFxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgY29uc3QgZGF0ZUFyeTogYW55W10gPSBbXTtcbiAgICAgIHJlc3VsdExpc3QgPSByZXN1bHRMaXN0LnJldmVyc2UoKTtcbiAgICAgIGxldCB7IG1lc3NhZ2VMaXN0IH0gPSB0aGlzLmRhdGE7XG4gICAgICBtZXNzYWdlTGlzdCA9IHJlc3VsdExpc3QuY29uY2F0KG1lc3NhZ2VMaXN0KTtcbiAgICAgIG1lc3NhZ2VMaXN0Lm1hcCgoaXRlbTogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBnZXREYXRlKGl0ZW0uY3JlYXRlZEF0KTtcbiAgICAgICAgaWYgKGRhdGVBcnkuaW5kZXhPZihkYXRlKSA9PSAtMSkge1xuICAgICAgICAgIGl0ZW0uZGF0ZSA9IGRhdGU7XG4gICAgICAgICAgZGF0ZUFyeS5wdXNoKGRhdGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGl0ZW0uZGF0ZSA9ICcnO1xuICAgICAgICB9XG4gICAgICAgIGl0ZW0udGltZSA9IGdldFRpbWUoaXRlbS5jcmVhdGVkQXQpO1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIG1lc3NhZ2VMaXN0XG4gICAgICB9KTtcbiAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XG4gICAgfSk7XG4gIH0sXG5cbiAgb25SZWZyZXNoOiBmdW5jdGlvbiAoZTogYW55KSB7XG4gICAgY29uc29sZS5sb2coJ29uUmVmcmVzaCcsIGUpXG4gICAgY29uc29sZS5sb2coJ29uUmVmcmVzaCcsIGUuZGV0YWlsLnNjcm9sbFRvcClcbiAgICBjb25zdCB7IHBhZ2luYXRpb24gfSA9IHRoaXMuZGF0YTtcbiAgICBpZiAoZS5kZXRhaWwuc2Nyb2xsVG9wID09PSAwICYmIHBhZ2luYXRpb24ucGFnZVRva2VuICE9PSAnJykge1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIG5lZWRUb1ZpZXc6IGZhbHNlLFxuICAgICAgfSk7XG4gICAgICB0aGlzLmdldE1lc3NhZ2VMaXN0KHBhZ2luYXRpb24ucGFnZVNpemUsIHBhZ2luYXRpb24ucGFnZVRva2VuKTtcbiAgICB9XG4gIH0sXG4gIFxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcbiAgICovXG4gIG9uUmVhZHk6IGZ1bmN0aW9uICgpIHtcblxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLpmpDol49cbiAgICovXG4gIG9uSGlkZTogZnVuY3Rpb24gKCkge1xuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWNuOi9vVxuICAgKi9cbiAgb25VbmxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICBDaGF0U2VydmljZS51cGRhdGVNc2dUb1JlYWRTdGF0dXModGhpcy5kYXRhLmNpZCk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCkge1xuICB9LFxuXG4gIC8qKlxuICAgKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcbiAgICovXG4gIG9uUmVhY2hCb3R0b206IGZ1bmN0aW9uICgpIHtcbiAgfSxcbn0pIl19