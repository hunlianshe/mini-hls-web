"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const socket_service2_1 = require("../../service/socket.service2");
const utils_1 = require("../../utils/utils");
const Api = require("../../service/api.service");
const ChatService = require("../../service/chat.service");
Page({
    data: {
        openid: '',
        cid: '',
        me: {},
        host: '',
        toUser: {},
        userInfo: {},
        message: '',
        pagination: { pageSize: 10, pageToken: '' },
        messageList: [],
        needToView: true,
        inputFocus: true,
    },
    onLoad: function (options) {
        let openid = options.openid;
        let cid = options.cid;
        this.setData({
            cid: cid,
            openid: openid,
        });
        const user = wx.getStorageSync('user');
        this.setData({
            me: user
        });
        this.readAllMessage();
        this.getToUserInfo(openid);
        const { pagination } = this.data;
        this.getMessageList(pagination.pageSize, pagination.pageToken);
        this.receiveMessage();
    },
    readAllMessage() {
        ChatService.updateMsgToReadStatus(this.data.cid);
    },
    getOpenid() {
        let openid = '';
        const user = wx.getStorageSync('user');
        openid = user.openid || '';
        return openid;
    },
    receiveMessage() {
        function getRandom(num) {
            return Math.floor((Math.random() + Math.floor(Math.random() * 9 + 1)) * Math.pow(10, num - 1));
        }
        console.log("准备接收消息");
        let socket = socket_service2_1.getSocket();
        socket.on("privateChat", (msg) => {
            console.log("接收到的消息是", msg);
            var messageList = this.data.messageList;
            console.log("getRandom(10)", getRandom(10));
            msg._id = getRandom(10);
            messageList.push(msg);
            console.log("`item${messageList.length}`", messageList.length);
            this.setData({ messageList });
            let toLast = `item${messageList.length}`;
            console.log('toLast', toLast);
            this.setData({
                scrollTop: 1000 * messageList.length
            });
        });
    },
    getToUserInfo(openid) {
        Api.getUserInfo(openid).then((result) => {
            if (result) {
                const userInfo = result.data;
                this.setData({
                    toUser: userInfo
                });
            }
            else {
                throw new Error("获取用户信息失败");
            }
        });
    },
    sendTap() {
        this.setData({
            needToView: true,
        });
        socket_service2_1.sendMessage({ cid: this.data.cid, msg: this.data.message, type: 1 });
        this.setChatSession();
    },
    setChatSession() {
        let chatSession = wx.getStorageSync('chatSession');
        let dateNow = new Date();
        if (chatSession && chatSession.updateTime && new Date(chatSession.updateTime).toDateString() == dateNow.toDateString()) {
            if (chatSession.openidList && chatSession.openidList.length > 0) {
                const index = chatSession.openidList.findIndex((openid) => openid === this.data.openid);
                if (index !== -1) {
                    return;
                }
                else {
                    chatSession.openidList.push(this.data.openid);
                    chatSession = {
                        updateTime: dateNow,
                        openidList: chatSession.openidList,
                    };
                }
            }
        }
        else {
            chatSession = {
                updateTime: dateNow,
                openidList: [this.data.openid]
            };
        }
        wx.setStorageSync("chatSession", chatSession);
    },
    inputTap(e) {
        this.setData({
            message: e.detail.detail.value
        });
    },
    inputBlur(e) {
        console.log('inputBlurinputBlurinputBlur');
        this.setData({
            inputFocus: false,
        });
    },
    inputFocus(e) {
        console.log('inputFocus');
        this.setData({
            inputFocus: true,
        });
    },
    uploadImage(e) {
        this.setData({
            needToView: true,
        });
        socket_service2_1.sendMessage({ cid: this.data.cid, msg: e.detail, type: 2 });
    },
    getMessageList(pageSize, pageToken) {
        wx.showLoading({ title: '' });
        Api.getMessageByCid(this.data.cid, pageSize, pageToken).then((result) => {
            let resultList = result.data.result;
            let lastId = result.data.nextPageToken;
            this.setData({
                pagination: {
                    pageToken: lastId,
                    pageSize: 10
                }
            });
            const dateAry = [];
            resultList = resultList.reverse();
            let { messageList } = this.data;
            messageList = resultList.concat(messageList);
            messageList.map((item) => {
                const date = utils_1.getDate(item.createdAt);
                if (dateAry.indexOf(date) == -1) {
                    item.date = date;
                    dateAry.push(date);
                }
                else {
                    item.date = '';
                }
                item.time = utils_1.getTime(item.createdAt);
                return item;
            });
            this.setData({
                messageList
            });
            wx.hideLoading();
        });
    },
    onRefresh: function (e) {
        console.log('onRefresh', e);
        console.log('onRefresh', e.detail.scrollTop);
        const { pagination } = this.data;
        if (e.detail.scrollTop === 0 && pagination.pageToken !== '') {
            this.setData({
                needToView: false,
            });
            this.getMessageList(pagination.pageSize, pagination.pageToken);
        }
    },
    onReady: function () {
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
        ChatService.updateMsgToReadStatus(this.data.cid);
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNoYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxtRUFBc0U7QUFDdEUsNkNBQXFEO0FBQ3JELGlEQUFpRDtBQUNqRCwwREFBMEQ7QUFFMUQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLEVBQUU7UUFDVixHQUFHLEVBQUUsRUFBRTtRQUNQLEVBQUUsRUFBRSxFQUFFO1FBQ04sSUFBSSxFQUFFLEVBQUU7UUFDUixNQUFNLEVBQUUsRUFBRTtRQUNWLFFBQVEsRUFBRSxFQUFFO1FBQ1osT0FBTyxFQUFFLEVBQUU7UUFDWCxVQUFVLEVBQUUsRUFBQyxRQUFRLEVBQUcsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUM7UUFDMUMsV0FBVyxFQUFFLEVBQUU7UUFDZixVQUFVLEVBQUUsSUFBSTtRQUNoQixVQUFVLEVBQUUsSUFBSTtLQUNqQjtJQUVELE1BQU0sRUFBRSxVQUFVLE9BQVc7UUFFM0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM1QixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDWixHQUFHLEVBQUUsR0FBRztZQUNSLE1BQU0sRUFBRSxNQUFNO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsT0FBUSxDQUFDO1lBQ1osRUFBRSxFQUFFLElBQUk7U0FDVCxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQixNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUs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LENBQUMsU0FBUyxDQUFDLENBQUE7UUFDNUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDakMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsS0FBSyxDQUFDLElBQUksVUFBVSxDQUFDLFNBQVMsS0FBSyxFQUFFLEVBQUU7WUFDM0QsSUFBSSxDQUFDLE9BQVEsQ0FBQztnQkFDWixVQUFVLEVBQUUsS0FBSzthQUNsQixDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ2hFO0lBQ0gsQ0FBQztJQUtELE9BQU8sRUFBRTtJQUVULENBQUM7SUFLRCxNQUFNLEVBQUU7SUFFUixDQUFDO0lBS0QsTUFBTSxFQUFFO0lBQ1IsQ0FBQztJQUtELFFBQVEsRUFBRTtRQUNSLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFLRCxpQkFBaUIsRUFBRTtJQUNuQixDQUFDO0lBS0QsYUFBYSxFQUFFO0lBQ2YsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Z2V0U29ja2V0LCBzZW5kTWVzc2FnZSB9IGZyb20gJy4uLy4uL3NlcnZpY2Uvc29ja2V0LnNlcnZpY2UyJztcbmltcG9ydCB7IGdldERhdGUsIGdldFRpbWUgfSBmcm9tICcuLi8uLi91dGlscy91dGlscyc7XG5pbXBvcnQgKiBhcyBBcGkgZnJvbSAnLi4vLi4vc2VydmljZS9hcGkuc2VydmljZSc7XG5pbXBvcnQgKiBhcyBDaGF0U2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlL2NoYXQuc2VydmljZSc7XG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgb3BlbmlkOiAnJywgLy8g5pS25L+h5Lq655qEb3BlbmlkXG4gICAgY2lkOiAnJyxcbiAgICBtZToge30sIC8vIOaIkeeahOeUqOaIt+S/oeaBr1xuICAgIGhvc3Q6ICcnLCAvLyDmiJHnmoTnlKjmiLfkv6Hmga9cbiAgICB0b1VzZXI6IHt9LCAvLyDmjqXmlLbkurrnmoTnlKjmiLfkv6Hmga9cbiAgICB1c2VySW5mbzoge30sIC8vIOeUqOaIt+S/oeaBr1xuICAgIG1lc3NhZ2U6ICcnLCAgLy8g55So5oi36L6T5YWl55qE5raI5oGvXG4gICAgcGFnaW5hdGlvbjoge3BhZ2VTaXplIDogMTAsIHBhZ2VUb2tlbjogJyd9LFxuICAgIG1lc3NhZ2VMaXN0OiBbXSxcbiAgICBuZWVkVG9WaWV3OiB0cnVlLFxuICAgIGlucHV0Rm9jdXM6IHRydWUsXG4gIH0sXG5cbiAgb25Mb2FkOiBmdW5jdGlvbiAob3B0aW9uczphbnkpIHtcbiAgICAvLyB0aGlzLmdldFVzZXJJbmZvKCk7XG4gICAgbGV0IG9wZW5pZCA9IG9wdGlvbnMub3BlbmlkO1xuICAgIGxldCBjaWQgPSBvcHRpb25zLmNpZDtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIGNpZDogY2lkLFxuICAgICAgb3BlbmlkOiBvcGVuaWQsXG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyID0gd3guZ2V0U3RvcmFnZVN5bmMoJ3VzZXInKTtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIG1lOiB1c2VyXG4gICAgfSk7XG4gICAgdGhpcy5yZWFkQWxsTWVzc2FnZSgpO1xuXG4gICAgdGhpcy5nZXRUb1VzZXJJbmZvKG9wZW5pZCk7XG4gICAgY29uc3QgeyBwYWdpbmF0aW9uIH0gPSB0aGlzLmRhdGE7XG4gICAgdGhpcy5nZXRNZXNzYWdlTGlzdChwYWdpbmF0aW9uLnBhZ2VTaXplLCBwYWdpbmF0aW9uLnBhZ2VUb2tlbik7XG4gICAgdGhpcy5yZWNlaXZlTWVzc2FnZSgpO1xuICB9LFxuXG4gIC8vIOiuvue9rua2iOaBr+W3suivu1xuICByZWFkQWxsTWVzc2FnZSgpIHtcbiAgICBDaGF0U2VydmljZS51cGRhdGVNc2dUb1JlYWRTdGF0dXModGhpcy5kYXRhLmNpZCk7XG4gIH0sXG5cbiAgZ2V0T3BlbmlkKCkge1xuICAgIGxldCBvcGVuaWQ6IHN0cmluZyA9ICcnO1xuICAgIGNvbnN0IHVzZXIgPSB3eC5nZXRTdG9yYWdlU3luYygndXNlcicpO1xuICAgIG9wZW5pZCA9IHVzZXIub3BlbmlkIHx8ICcnO1xuICAgIHJldHVybiBvcGVuaWQ7XG4gIH0sXG5cbiAgcmVjZWl2ZU1lc3NhZ2UoKSB7XG4gICAgZnVuY3Rpb24gZ2V0UmFuZG9tKG51bTogYW55KXtcbiAgICAgIHJldHVybiBNYXRoLmZsb29yKChNYXRoLnJhbmRvbSgpK01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSo5KzEpKSpNYXRoLnBvdygxMCxudW0tMSkpO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhcIuWHhuWkh+aOpeaUtua2iOaBr1wiKVxuICAgIGxldCBzb2NrZXQgPSBnZXRTb2NrZXQoKVxuICAgIHNvY2tldC5vbihcInByaXZhdGVDaGF0XCIsIChtc2c6YW55KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIuaOpeaUtuWIsOeahOa2iOaBr+aYr1wiLG1zZylcbiAgICAgIHZhciBtZXNzYWdlTGlzdDogYW55ID0gdGhpcy5kYXRhLm1lc3NhZ2VMaXN0O1xuICAgICAgY29uc29sZS5sb2coXCJnZXRSYW5kb20oMTApXCIsZ2V0UmFuZG9tKDEwKSk7XG4gICAgICBtc2cuX2lkID0gZ2V0UmFuZG9tKDEwKVxuICAgICAgbWVzc2FnZUxpc3QucHVzaChtc2cpO1xuICAgICAgY29uc29sZS5sb2coXCJgaXRlbSR7bWVzc2FnZUxpc3QubGVuZ3RofWBcIixtZXNzYWdlTGlzdC5sZW5ndGgpXG4gICAgICB0aGlzLnNldERhdGEhKHttZXNzYWdlTGlzdH0pXG4gICAgICBsZXQgdG9MYXN0ID0gYGl0ZW0ke21lc3NhZ2VMaXN0Lmxlbmd0aH1gXG4gICAgICBjb25zb2xlLmxvZygndG9MYXN0Jyx0b0xhc3QpXG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgc2Nyb2xsVG9wOiAxMDAwICogbWVzc2FnZUxpc3QubGVuZ3RoICAvLyDov5nph4zmiJHku6znmoTljZXlr7nor53ljLrln5/mnIDpq5gxMDAw77yM5Y+W5LqG5pyA5aSn5YC877yM5bqU6K+l5pyJ5pa55rOV5Y+W5Yiw57K+56Gu55qEXG4gICAgICB9KTtcbiAgICB9KVxuICB9LFxuXG4gIC8vIOa2iOaBr+WvueaWueeahOS/oeaBr1xuICBnZXRUb1VzZXJJbmZvKG9wZW5pZDogc3RyaW5nKSB7XG4gICAgQXBpLmdldFVzZXJJbmZvKG9wZW5pZCkudGhlbigocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgY29uc3QgdXNlckluZm8gPSByZXN1bHQuZGF0YTtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgdG9Vc2VyOiB1c2VySW5mb1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIuiOt+WPlueUqOaIt+S/oeaBr+Wksei0pVwiKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICAvKiog5Y+R6YCB5raI5oGv5LqL5Lu2ICovXG4gIHNlbmRUYXAoKSB7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBuZWVkVG9WaWV3OiB0cnVlLFxuICAgIH0pO1xuICAgIHNlbmRNZXNzYWdlKHtjaWQ6IHRoaXMuZGF0YS5jaWQsIG1zZzogdGhpcy5kYXRhLm1lc3NhZ2UsIHR5cGU6IDF9KTtcbiAgICB0aGlzLnNldENoYXRTZXNzaW9uKCk7XG4gIH0sXG5cbiAgc2V0Q2hhdFNlc3Npb24oKSB7XG4gICAgbGV0IGNoYXRTZXNzaW9uID0gd3guZ2V0U3RvcmFnZVN5bmMoJ2NoYXRTZXNzaW9uJyk7XG4gICAgbGV0IGRhdGVOb3cgPSBuZXcgRGF0ZSgpO1xuICAgIC8vIOWIpOaWreaYr+WQpuaYr+WQjOS4gOWkqVxuICAgIGlmIChjaGF0U2Vzc2lvbiAmJiBjaGF0U2Vzc2lvbi51cGRhdGVUaW1lICYmIG5ldyBEYXRlKGNoYXRTZXNzaW9uLnVwZGF0ZVRpbWUpLnRvRGF0ZVN0cmluZygpID09IGRhdGVOb3cudG9EYXRlU3RyaW5nKCkpIHtcbiAgICAgIC8vIOWOu+mHjeWQjuWtmOWFpeiBiuWkqeS6uuWIl+ihqFxuICAgICAgaWYgKGNoYXRTZXNzaW9uLm9wZW5pZExpc3QgJiYgY2hhdFNlc3Npb24ub3BlbmlkTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gY2hhdFNlc3Npb24ub3BlbmlkTGlzdC5maW5kSW5kZXgoKG9wZW5pZDogYW55KSA9PiBvcGVuaWQgPT09IHRoaXMuZGF0YS5vcGVuaWQpXG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY2hhdFNlc3Npb24ub3BlbmlkTGlzdC5wdXNoKHRoaXMuZGF0YS5vcGVuaWQpO1xuICAgICAgICAgIGNoYXRTZXNzaW9uID0ge1xuICAgICAgICAgICAgdXBkYXRlVGltZTogZGF0ZU5vdyxcbiAgICAgICAgICAgIG9wZW5pZExpc3Q6IGNoYXRTZXNzaW9uLm9wZW5pZExpc3QsXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNoYXRTZXNzaW9uID0ge1xuICAgICAgICB1cGRhdGVUaW1lOiBkYXRlTm93LFxuICAgICAgICBvcGVuaWRMaXN0OiBbdGhpcy5kYXRhLm9wZW5pZF1cbiAgICAgIH1cbiAgICB9XG4gICAgd3guc2V0U3RvcmFnZVN5bmMoXCJjaGF0U2Vzc2lvblwiLCBjaGF0U2Vzc2lvbik7XG4gIH0sXG5cbiAgLyoqIOi+k+WFpea2iOaBr+WGheWuuSAqL1xuICBpbnB1dFRhcChlOiBhbnkpIHtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIG1lc3NhZ2U6IGUuZGV0YWlsLmRldGFpbC52YWx1ZSAvLyDojrflj5bovpPlhaXnmoTlgLxcbiAgICB9KVxuICB9LFxuXG4gIGlucHV0Qmx1cihlOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnaW5wdXRCbHVyaW5wdXRCbHVyaW5wdXRCbHVyJylcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIGlucHV0Rm9jdXM6IGZhbHNlLFxuICAgIH0pO1xuICB9LFxuXG4gIGlucHV0Rm9jdXMoZTogYW55KSB7XG4gICAgY29uc29sZS5sb2coJ2lucHV0Rm9jdXMnKVxuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgaW5wdXRGb2N1czogdHJ1ZSxcbiAgICB9KTtcbiAgfSxcblxuICAgLyoqIOi+k+WFpea2iOaBr+WGheWuuSAqL1xuICAgdXBsb2FkSW1hZ2UoZTogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBuZWVkVG9WaWV3OiB0cnVlLFxuICAgIH0pO1xuICAgIHNlbmRNZXNzYWdlKHtjaWQ6IHRoaXMuZGF0YS5jaWQsIG1zZzogZS5kZXRhaWwsIHR5cGU6IDJ9KVxuICB9LFxuXG4gIGdldE1lc3NhZ2VMaXN0KHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VUb2tlbjogc3RyaW5nKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoe3RpdGxlOiAnJ30pO1xuICAgIEFwaS5nZXRNZXNzYWdlQnlDaWQodGhpcy5kYXRhLmNpZCwgcGFnZVNpemUsIHBhZ2VUb2tlbikudGhlbigocmVzdWx0OmFueSkgPT4ge1xuICAgICAgbGV0IHJlc3VsdExpc3QgPSByZXN1bHQuZGF0YS5yZXN1bHQ7XG4gICAgICBsZXQgbGFzdElkID0gcmVzdWx0LmRhdGEubmV4dFBhZ2VUb2tlbjtcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgcGFnZVRva2VuOiBsYXN0SWQsXG4gICAgICAgICAgcGFnZVNpemU6IDEwXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICBjb25zdCBkYXRlQXJ5OiBhbnlbXSA9IFtdO1xuICAgICAgcmVzdWx0TGlzdCA9IHJlc3VsdExpc3QucmV2ZXJzZSgpO1xuICAgICAgbGV0IHsgbWVzc2FnZUxpc3QgfSA9IHRoaXMuZGF0YTtcbiAgICAgIG1lc3NhZ2VMaXN0ID0gcmVzdWx0TGlzdC5jb25jYXQobWVzc2FnZUxpc3QpO1xuICAgICAgbWVzc2FnZUxpc3QubWFwKChpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgZGF0ZSA9IGdldERhdGUoaXRlbS5jcmVhdGVkQXQpO1xuICAgICAgICBpZiAoZGF0ZUFyeS5pbmRleE9mKGRhdGUpID09IC0xKSB7XG4gICAgICAgICAgaXRlbS5kYXRlID0gZGF0ZTtcbiAgICAgICAgICBkYXRlQXJ5LnB1c2goZGF0ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaXRlbS5kYXRlID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgaXRlbS50aW1lID0gZ2V0VGltZShpdGVtLmNyZWF0ZWRBdCk7XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgbWVzc2FnZUxpc3RcbiAgICAgIH0pO1xuICAgICAgd3guaGlkZUxvYWRpbmcoKTtcbiAgICB9KTtcbiAgfSxcblxuICBvblJlZnJlc2g6IGZ1bmN0aW9uIChlOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnb25SZWZyZXNoJywgZSlcbiAgICBjb25zb2xlLmxvZygnb25SZWZyZXNoJywgZS5kZXRhaWwuc2Nyb2xsVG9wKVxuICAgIGNvbnN0IHsgcGFnaW5hdGlvbiB9ID0gdGhpcy5kYXRhO1xuICAgIGlmIChlLmRldGFpbC5zY3JvbGxUb3AgPT09IDAgJiYgcGFnaW5hdGlvbi5wYWdlVG9rZW4gIT09ICcnKSB7XG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgbmVlZFRvVmlldzogZmFsc2UsXG4gICAgICB9KTtcbiAgICAgIHRoaXMuZ2V0TWVzc2FnZUxpc3QocGFnaW5hdGlvbi5wYWdlU2l6ZSwgcGFnaW5hdGlvbi5wYWdlVG9rZW4pO1xuICAgIH1cbiAgfSxcbiAgXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWIneasoea4suafk+WujOaIkFxuICAgKi9cbiAgb25SZWFkeTogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5pi+56S6XG4gICAqL1xuICBvblNob3c6IGZ1bmN0aW9uICgpIHtcblxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdoumakOiXj1xuICAgKi9cbiAgb25IaWRlOiBmdW5jdGlvbiAoKSB7XG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuICAgIENoYXRTZXJ2aWNlLnVwZGF0ZU1zZ1RvUmVhZFN0YXR1cyh0aGlzLmRhdGEuY2lkKTtcbiAgfSxcblxuICAvKipcbiAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICovXG4gIG9uUHVsbERvd25SZWZyZXNoOiBmdW5jdGlvbiAoKSB7XG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouS4iuaLieinpuW6leS6i+S7tueahOWkhOeQhuWHveaVsFxuICAgKi9cbiAgb25SZWFjaEJvdHRvbTogZnVuY3Rpb24gKCkge1xuICB9LFxufSkiXX0=