"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const socket_service2_1 = require("../../service/socket.service2");
const utils_1 = require("../../utils/utils");
const Api = require("../../service/api.service");
Page({
    data: {
        openid: '',
        cid: '',
        me: {},
        host: '',
        toUser: {},
        userInfo: {},
        message: '',
        toLast: '',
        scrollTop: 0,
        pagination: { pageSize: 10, pageToken: '' },
        messageList: [],
    },
    onLoad: function (options) {
        console.log("okkkk");
        let openid = options.openid;
        let cid = options.cid;
        this.setData({
            cid: cid
        });
        console.log("openid", openid);
        console.log("cid", cid);
        const user = wx.getStorageSync('user');
        console.log("user", user);
        this.setData({
            me: user
        });
        this.getToUserInfo(openid);
        const { pagination } = this.data;
        this.getMessageList(pagination.pageSize, pagination.pageToken);
        this.receiveMessage();
    },
    getOpenid() {
        let openid = '';
        const user = wx.getStorageSync('user');
        openid = user.openid || '';
        return openid;
    },
    receiveMessage() {
        function getRandom(num) {
            return Math.floor((Math.random() + Math.floor(Math.random() * 9 + 1)) * Math.pow(10, num - 1));
        }
        console.log("准备接收消息");
        let socket = socket_service2_1.getSocket();
        socket.on("privateChat", (msg) => {
            console.log("接收到的消息是", msg);
            var messageList = this.data.messageList;
            console.log("getRandom(10)", getRandom(10));
            msg._id = getRandom(10);
            messageList.push(msg);
            console.log("`item${messageList.length}`", messageList.length);
            this.setData({ messageList });
            let toLast = `item${messageList.length}`;
            console.log('toLast', toLast);
            this.setData({ toLast });
            this.setData({
                scrollTop: 1000 * messageList.length
            });
        });
    },
    getToUserInfo(openid) {
        Api.getUserInfo(openid).then((result) => {
            if (result) {
                const userInfo = result.data;
                console.log('userInfo:', userInfo);
                this.setData({
                    toUser: userInfo
                });
            }
            else {
                throw new Error("获取用户信息失败");
            }
        });
    },
    sendTap() {
        socket_service2_1.sendMessage({ cid: this.data.cid, msg: this.data.message, type: 1 });
        console.log('send message:', this.data.message);
    },
    setChatSession() {
        let chatSession = wx.getStorageSync('chatSession');
        let dateNow = new Date();
        if (chatSession.updateTime && chatSession.updateTime.toDateString() == dateNow.toDateString()) {
            if (chatSession.openidList) {
                const index = chatSession.openidList.findIndex((openid) => openid === this.data.openid);
                if (index) {
                    return;
                }
                else {
                    chatSession = {
                        updateTime: dateNow,
                        openidList: chatSession.openidList.push(this.data.openid)
                    };
                }
            }
        }
        else {
            chatSession = {
                updateTime: dateNow,
                openidList: [this.data.openid]
            };
        }
        console.log('chatSession:', chatSession);
        wx.setStorageSync("chatSession", chatSession);
        utils_1.setRightStorage('fateChat');
    },
    inputTap(e) {
        console.log('input message:', e);
        this.setData({
            message: e.detail.detail.value
        });
    },
    uploadImage(e) {
        console.log('upload image:', e.detail);
        socket_service2_1.sendMessage({ cid: this.data.cid, msg: e.detail, type: 2 });
    },
    getMessageList(pageSize, pageToken) {
        Api.getMessageByCid(this.data.cid, pageSize, pageToken).then((result) => {
            console.log("result.data", result.data);
            let resultList = result.data.result;
            let lastId = result.data.nextPageToken;
            this.setData({
                pagination: {
                    pageToken: lastId,
                    pageSize: 10
                }
            });
            const dateAry = [];
            resultList.map((item) => {
                const date = utils_1.getDate(item.createdAt);
                if (dateAry.indexOf(date) == -1) {
                    item.date = date;
                    dateAry.push(date);
                }
                else {
                    item.date = '';
                }
                item.time = utils_1.getTime(item.createdAt);
                return item;
            });
            let { messageList } = this.data;
            messageList = resultList.concat(messageList);
            console.log(messageList[messageList.length - 1]._id);
            this.setData({
                messageList,
                toLast: `item${messageList.length}`,
                scrollTop: 1000 * messageList.length
            });
        });
    },
    onPageScroll: function (res) {
        console.log(res);
        const { pagination } = this.data;
        if (res.scrollTop === 0 && pagination.pageToken !== '') {
            this.getMessageList(pagination.pageSize, pagination.pageToken);
        }
    },
    onReady: function () {
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNoYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxtRUFBc0U7QUFDdEUsNkNBQXNFO0FBQ3RFLGlEQUFpRDtBQUVqRCxJQUFJLENBQUM7SUFDSCxJQUFJLEVBQUU7UUFDSixNQUFNLEVBQUUsRUFBRTtRQUNWLEdBQUcsRUFBRSxFQUFFO1FBQ1AsRUFBRSxFQUFFLEVBQUU7UUFDTixJQUFJLEVBQUUsRUFBRTtRQUNSLE1BQU0sRUFBRSxFQUFFO1FBQ1YsUUFBUSxFQUFFLEVBQUU7UUFDWixPQUFPLEVBQUUsRUFBRTtRQUNYLE1BQU0sRUFBRSxFQUFFO1FBQ1YsU0FBUyxFQUFDLENBQUM7UUFDWCxVQUFVLEVBQUUsRUFBQyxRQUFRLEVBQUcsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUM7UUFDMUMsV0FBVyxFQUFFLEVBQUU7S0FDaEI7SUFFRCxNQUFNLEVBQUUsVUFBVSxPQUFXO1FBRTNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDcEIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM1QixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDWixHQUFHLEVBQUUsR0FBRztTQUNULENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRXRCLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUMsSUFBSSxDQUFDLENBQUE7UUFHeEIsSUFBSSxDQUFDLE9BQVEsQ0FBQztZQUNaLEVBQUUsRUFBRSxJQUFJO1NBQ1QsQ0FB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S0FBSyxDQUFDLElBQUksVUFBVSxDQUFDLFNBQVMsS0FBSyxFQUFFLEVBQUU7WUFDdEQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNoRTtJQUNILENBQUM7SUFLRCxPQUFPLEVBQUU7SUFFVCxDQUFDO0lBS0QsTUFBTSxFQUFFO0lBRVIsQ0FBQztJQUtELE1BQU0sRUFBRTtJQUVSLENBQUM7SUFLRCxRQUFRLEVBQUU7SUFFVixDQUFDO0lBS0QsaUJBQWlCLEVBQUU7SUFDbkIsQ0FBQztJQUtELGFBQWEsRUFBRTtJQUNmLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2dldFNvY2tldCwgc2VuZE1lc3NhZ2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlL3NvY2tldC5zZXJ2aWNlMic7XG5pbXBvcnQgeyBnZXREYXRlLCBnZXRUaW1lLCBzZXRSaWdodFN0b3JhZ2UgfSBmcm9tICcuLi8uLi91dGlscy91dGlscyc7XG5pbXBvcnQgKiBhcyBBcGkgZnJvbSAnLi4vLi4vc2VydmljZS9hcGkuc2VydmljZSc7XG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgb3BlbmlkOiAnJywgLy8g5pS25L+h5Lq655qEb3BlbmlkXG4gICAgY2lkOiAnJyxcbiAgICBtZToge30sIC8vIOaIkeeahOeUqOaIt+S/oeaBr1xuICAgIGhvc3Q6ICcnLCAvLyDmiJHnmoTnlKjmiLfkv6Hmga9cbiAgICB0b1VzZXI6IHt9LCAvLyDmjqXmlLbkurrnmoTnlKjmiLfkv6Hmga9cbiAgICB1c2VySW5mbzoge30sIC8vIOeUqOaIt+S/oeaBr1xuICAgIG1lc3NhZ2U6ICcnLCAgLy8g55So5oi36L6T5YWl55qE5raI5oGvXG4gICAgdG9MYXN0OiAnJyxcbiAgICBzY3JvbGxUb3A6MCxcbiAgICBwYWdpbmF0aW9uOiB7cGFnZVNpemUgOiAxMCwgcGFnZVRva2VuOiAnJ30sXG4gICAgbWVzc2FnZUxpc3Q6IFtdLFxuICB9LFxuXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnM6YW55KSB7XG4gICAgLy8gdGhpcy5nZXRVc2VySW5mbygpO1xuICAgIGNvbnNvbGUubG9nKFwib2tra2tcIilcbiAgICBsZXQgb3BlbmlkID0gb3B0aW9ucy5vcGVuaWQ7XG4gICAgbGV0IGNpZCA9IG9wdGlvbnMuY2lkO1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgY2lkOiBjaWRcbiAgICB9KTtcbiAgICBjb25zb2xlLmxvZyhcIm9wZW5pZFwiLG9wZW5pZClcbiAgICBjb25zb2xlLmxvZyhcImNpZFwiLGNpZClcblxuICAgIGNvbnN0IHVzZXIgPSB3eC5nZXRTdG9yYWdlU3luYygndXNlcicpO1xuICAgIGNvbnNvbGUubG9nKFwidXNlclwiLHVzZXIpXG4gICAgLy8gb3BlbmlkID0gdXNlci5vcGVuaWQgfHwgJyc7XG4gICAgLy8gcmV0dXJuIG9wZW5pZDtcbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIG1lOiB1c2VyXG4gICAgfSk7XG5cbiAgICB0aGlzLmdldFRvVXNlckluZm8ob3BlbmlkKTtcbiAgICBjb25zdCB7IHBhZ2luYXRpb24gfSA9IHRoaXMuZGF0YTtcbiAgICB0aGlzLmdldE1lc3NhZ2VMaXN0KHBhZ2luYXRpb24ucGFnZVNpemUsIHBhZ2luYXRpb24ucGFnZVRva2VuKTtcbiAgICB0aGlzLnJlY2VpdmVNZXNzYWdlKCk7XG4gIH0sXG5cbiAgZ2V0T3BlbmlkKCkge1xuICAgIGxldCBvcGVuaWQ6IHN0cmluZyA9ICcnO1xuICAgIGNvbnN0IHVzZXIgPSB3eC5nZXRTdG9yYWdlU3luYygndXNlcicpO1xuICAgIG9wZW5pZCA9IHVzZXIub3BlbmlkIHx8ICcnO1xuICAgIHJldHVybiBvcGVuaWQ7XG4gIH0sXG5cblxuXG4gIHJlY2VpdmVNZXNzYWdlKCkge1xuICAgIGZ1bmN0aW9uIGdldFJhbmRvbShudW0pe1xuICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkrTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKjkrMSkpKk1hdGgucG93KDEwLG51bS0xKSk7XG4gIH1cbiAgICBjb25zb2xlLmxvZyhcIuWHhuWkh+aOpeaUtua2iOaBr1wiKVxuICAgbGV0IHNvY2tldCA9IGdldFNvY2tldCgpXG4gICBzb2NrZXQub24oXCJwcml2YXRlQ2hhdFwiLCAobXNnOmFueSkgPT4ge1xuICAgICBjb25zb2xlLmxvZyhcIuaOpeaUtuWIsOeahOa2iOaBr+aYr1wiLG1zZylcbiAgICAgdmFyIG1lc3NhZ2VMaXN0OiBhbnkgPSB0aGlzLmRhdGEubWVzc2FnZUxpc3Q7XG4gICAgIGNvbnNvbGUubG9nKFwiZ2V0UmFuZG9tKDEwKVwiLGdldFJhbmRvbSgxMCkpO1xuICAgICBtc2cuX2lkID0gZ2V0UmFuZG9tKDEwKVxuICAgICBtZXNzYWdlTGlzdC5wdXNoKG1zZyk7XG4gICAgIGNvbnNvbGUubG9nKFwiYGl0ZW0ke21lc3NhZ2VMaXN0Lmxlbmd0aH1gXCIsbWVzc2FnZUxpc3QubGVuZ3RoKVxuICAgICB0aGlzLnNldERhdGEhKHttZXNzYWdlTGlzdH0pXG4gICAgIGxldCB0b0xhc3QgPSBgaXRlbSR7bWVzc2FnZUxpc3QubGVuZ3RofWBcbiAgICAgY29uc29sZS5sb2coJ3RvTGFzdCcsdG9MYXN0KVxuICAgICB0aGlzLnNldERhdGEhKHt0b0xhc3QgfSlcbiAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHNjcm9sbFRvcDogMTAwMCAqIG1lc3NhZ2VMaXN0Lmxlbmd0aCAgLy8g6L+Z6YeM5oiR5Lus55qE5Y2V5a+56K+d5Yy65Z+f5pyA6auYMTAwMO+8jOWPluS6huacgOWkp+WAvO+8jOW6lOivpeacieaWueazleWPluWIsOeyvuehrueahFxuICAgIH0pO1xuXG4gICB9KVxuXG4gIH0sXG5cbiAgLy8g5raI5oGv5a+55pa555qE5L+h5oGvXG4gIGdldFRvVXNlckluZm8ob3BlbmlkOiBzdHJpbmcpIHtcbiAgICBBcGkuZ2V0VXNlckluZm8ob3BlbmlkKS50aGVuKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBjb25zdCB1c2VySW5mbyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICBjb25zb2xlLmxvZygndXNlckluZm86JywgdXNlckluZm8pXG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIHRvVXNlcjogdXNlckluZm9cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCLojrflj5bnlKjmiLfkv6Hmga/lpLHotKVcIik7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqIOWPkemAgea2iOaBr+S6i+S7tiAqL1xuICBzZW5kVGFwKCkge1xuICAgIHNlbmRNZXNzYWdlKHtjaWQ6IHRoaXMuZGF0YS5jaWQsIG1zZzogdGhpcy5kYXRhLm1lc3NhZ2UsIHR5cGU6IDF9KTtcbiAgICBjb25zb2xlLmxvZygnc2VuZCBtZXNzYWdlOicsIHRoaXMuZGF0YS5tZXNzYWdlKTtcblxuICAgIC8vIHRoaXMuc2V0Q2hhdFNlc3Npb24oKTtcbiAgfSxcblxuICBzZXRDaGF0U2Vzc2lvbigpIHtcbiAgICBsZXQgY2hhdFNlc3Npb24gPSB3eC5nZXRTdG9yYWdlU3luYygnY2hhdFNlc3Npb24nKTtcbiAgICBsZXQgZGF0ZU5vdyA9IG5ldyBEYXRlKCk7XG4gICAgLy8g5Yik5pat5piv5ZCm5piv5ZCM5LiA5aSpXG4gICAgaWYgKGNoYXRTZXNzaW9uLnVwZGF0ZVRpbWUgJiYgY2hhdFNlc3Npb24udXBkYXRlVGltZS50b0RhdGVTdHJpbmcoKSA9PSBkYXRlTm93LnRvRGF0ZVN0cmluZygpKSB7XG4gICAgICAvLyDljrvph43lkI7lrZjlhaXogYrlpKnkurrliJfooahcbiAgICAgIGlmIChjaGF0U2Vzc2lvbi5vcGVuaWRMaXN0KSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gY2hhdFNlc3Npb24ub3BlbmlkTGlzdC5maW5kSW5kZXgoKG9wZW5pZDogYW55KSA9PiBvcGVuaWQgPT09IHRoaXMuZGF0YS5vcGVuaWQpXG4gICAgICAgIGlmIChpbmRleCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjaGF0U2Vzc2lvbiA9IHtcbiAgICAgICAgICAgIHVwZGF0ZVRpbWU6IGRhdGVOb3csXG4gICAgICAgICAgICBvcGVuaWRMaXN0OiBjaGF0U2Vzc2lvbi5vcGVuaWRMaXN0LnB1c2godGhpcy5kYXRhLm9wZW5pZClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY2hhdFNlc3Npb24gPSB7XG4gICAgICAgIHVwZGF0ZVRpbWU6IGRhdGVOb3csXG4gICAgICAgIG9wZW5pZExpc3Q6IFt0aGlzLmRhdGEub3BlbmlkXVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zb2xlLmxvZygnY2hhdFNlc3Npb246JywgY2hhdFNlc3Npb24pXG4gICAgd3guc2V0U3RvcmFnZVN5bmMoXCJjaGF0U2Vzc2lvblwiLCBjaGF0U2Vzc2lvbik7XG4gICAgc2V0UmlnaHRTdG9yYWdlKCdmYXRlQ2hhdCcpO1xuICB9LFxuXG4gIC8qKiDovpPlhaXmtojmga/lhoXlrrkgKi9cbiAgaW5wdXRUYXAoZTogYW55KSB7XG4gICAgY29uc29sZS5sb2coJ2lucHV0IG1lc3NhZ2U6JywgZSk7XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBtZXNzYWdlOiBlLmRldGFpbC5kZXRhaWwudmFsdWUgLy8g6I635Y+W6L6T5YWl55qE5YC8XG4gICAgfSlcbiAgfSxcblxuICAgLyoqIOi+k+WFpea2iOaBr+WGheWuuSAqL1xuICAgdXBsb2FkSW1hZ2UoZTogYW55KSB7XG4gICAgY29uc29sZS5sb2coJ3VwbG9hZCBpbWFnZTonLCBlLmRldGFpbCk7XG4gICAgc2VuZE1lc3NhZ2Uoe2NpZDogdGhpcy5kYXRhLmNpZCwgbXNnOiBlLmRldGFpbCwgdHlwZTogMn0pXG4gIH0sXG5cbiAgZ2V0TWVzc2FnZUxpc3QocGFnZVNpemU6IG51bWJlciwgcGFnZVRva2VuOiBzdHJpbmcpIHtcbiAgICBBcGkuZ2V0TWVzc2FnZUJ5Q2lkKHRoaXMuZGF0YS5jaWQsIHBhZ2VTaXplLCBwYWdlVG9rZW4pLnRoZW4oKHJlc3VsdDphbnkpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwicmVzdWx0LmRhdGFcIixyZXN1bHQuZGF0YSlcbiAgICAgIGxldCByZXN1bHRMaXN0ID0gcmVzdWx0LmRhdGEucmVzdWx0O1xuICAgICAgbGV0IGxhc3RJZCA9IHJlc3VsdC5kYXRhLm5leHRQYWdlVG9rZW47XG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgIHBhZ2VUb2tlbjogbGFzdElkLFxuICAgICAgICAgIHBhZ2VTaXplOiAxMFxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgY29uc3QgZGF0ZUFyeTogYW55W10gPSBbXTtcbiAgICAgIHJlc3VsdExpc3QubWFwKChpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgZGF0ZSA9IGdldERhdGUoaXRlbS5jcmVhdGVkQXQpO1xuICAgICAgICBpZiAoZGF0ZUFyeS5pbmRleE9mKGRhdGUpID09IC0xKSB7XG4gICAgICAgICAgaXRlbS5kYXRlID0gZGF0ZTtcbiAgICAgICAgICBkYXRlQXJ5LnB1c2goZGF0ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaXRlbS5kYXRlID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgaXRlbS50aW1lID0gZ2V0VGltZShpdGVtLmNyZWF0ZWRBdCk7XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSk7XG4gICAgICAvLyByZXN1bHRMaXN0ID0gcmVzdWx0TGlzdC5yZXZlcnNlKCk7XG4gICAgICBsZXQgeyBtZXNzYWdlTGlzdCB9ID0gdGhpcy5kYXRhO1xuICAgICAgbWVzc2FnZUxpc3QgPSByZXN1bHRMaXN0LmNvbmNhdChtZXNzYWdlTGlzdCk7XG4gICAgICBjb25zb2xlLmxvZyhtZXNzYWdlTGlzdFttZXNzYWdlTGlzdC5sZW5ndGggLTFdLl9pZClcbiAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICBtZXNzYWdlTGlzdCxcbiAgICAgICAgdG9MYXN0OiBgaXRlbSR7bWVzc2FnZUxpc3QubGVuZ3RofWAsXG4gICAgICAgIHNjcm9sbFRvcDogMTAwMCAqIG1lc3NhZ2VMaXN0Lmxlbmd0aCAgLy8g6L+Z6YeM5oiR5Lus55qE5Y2V5a+56K+d5Yy65Z+f5pyA6auYMTAwMO+8jOWPluS6huacgOWkp+WAvO+8jOW6lOivpeacieaWueazleWPluWIsOeyvuehrueahFxuXG4gICAgICB9KTtcbiAgICB9KVxuICBcbiAgfSxcblxuICBvblBhZ2VTY3JvbGw6IGZ1bmN0aW9uIChyZXMpIHtcbiAgIC8vIOmhtemdoua7muWKqOaXtuaJp+ihjFxuICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgY29uc3QgeyBwYWdpbmF0aW9uIH0gPSB0aGlzLmRhdGE7XG4gICAgaWYgKHJlcy5zY3JvbGxUb3AgPT09IDAgJiYgcGFnaW5hdGlvbi5wYWdlVG9rZW4gIT09ICcnKSB7XG4gICAgICB0aGlzLmdldE1lc3NhZ2VMaXN0KHBhZ2luYXRpb24ucGFnZVNpemUsIHBhZ2luYXRpb24ucGFnZVRva2VuKTtcbiAgICB9XG4gIH0sXG4gIFxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcbiAgICovXG4gIG9uUmVhZHk6IGZ1bmN0aW9uICgpIHtcblxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLpmpDol49cbiAgICovXG4gIG9uSGlkZTogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCkge1xuICB9LFxuXG4gIC8qKlxuICAgKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcbiAgICovXG4gIG9uUmVhY2hCb3R0b206IGZ1bmN0aW9uICgpIHtcbiAgfSxcbn0pIl19