"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Api = require("../../../service/api.service");
Page({
    data: {
        payInfo: {},
        userInfo: {},
        payItems: [
            {
                value: "wx",
                name: "微信支付",
                iconName: "wx",
                balance: "",
                checked: true,
            },
            {
                value: "yfb",
                name: "缘分币支付",
                iconName: "moneyRecharge",
                balance: 80,
                checked: false,
            },
        ],
        shooseType: "wx",
    },
    onLoad: function (options) {
        const user = wx.getStorageSync("userInfo");
        console.log("userInfo", user);
        let payItems = this.data.payItems;
        payItems[1] = Object.assign({}, payItems[1], { balance: user.coin || 0 });
        this.setData({
            userInfo: Object.assign({}, user),
            payItems,
        });
        console.log(`===options===`, options);
        if (options.payInfo) {
            this.setData({
                payInfo: JSON.parse(options.payInfo),
            });
        }
    },
    radioChange(e) {
        console.log("radio发生change事件，选择的支付方式为：", e.detail.value);
        const payItems = this.data.payItems;
        for (let i = 0, len = payItems.length; i < len; ++i) {
            payItems[i].checked = payItems[i].value === e.detail.value;
        }
        this.setData({
            payItems,
            shooseType: e.detail.value,
        });
    },
    goPay() {
        const { payInfo, shooseType, userInfo } = this.data;
        const coin = userInfo.coin || 0;
        console.log(`payInfo, shooseType`, shooseType);
        if (shooseType === "yfb" && coin < payInfo.value) {
            wx.showToast({
                title: "余额不足",
                icon: "none",
                duration: 2000,
            });
        }
        if (shooseType === "yfb" && payInfo.currentPrice) {
            this.coinPay();
        }
        else if (shooseType === "wx" && payInfo.currentPrice) {
            this.wxPay();
        }
        console.log("根据支付方式调用接口");
    },
    coinPay: function () {
        let that = this;
        const reqParams = this.preparePayInfo();
        console.log(`-----reqParams-----`, reqParams);
        Api.buyVipByCoin(reqParams).then((result) => {
            console.log(result);
            if (result && result.code === 200) {
                console.log(`coin pay付款结束complete: `, result);
                that.requestForUserInfo();
                wx.navigateTo({
                    url: `../paySuccess/paySuccess`,
                });
            }
        });
    },
    wxPay: function () {
        const reqParams = this.preparePayInfo();
        Api.buyVipByWechat(reqParams).then((result) => {
            console.log(result);
            if (result && result.code === 200) {
                let data = result.data;
                this.callWxForPay(data);
            }
        });
        console.log("wxPay");
    },
    callWxForPay: function (data) {
        const that = this;
        wx.requestPayment({
            timeStamp: data.timeStamp,
            nonceStr: data.nonceStr,
            package: "prepay_id=" + data.prepayId,
            signType: "MD5",
            paySign: data.paySign,
            success(res) {
                console.log(`付款成功: `, res);
            },
            fail(res) {
                console.log(`付款失败: `, res);
            },
            complete(res) {
                console.log(`付款结束complete: `, res);
                Api.checkOrderStatus(data.orderNum).then((result) => {
                    if (result && result.code === 200) {
                        that.requestForUserInfo();
                        wx.navigateTo({
                            url: `../paySuccess/paySuccess`,
                        });
                    }
                });
            },
        });
    },
    requestForUserInfo() {
        Api.getUserInfo(this.data.userInfo.openid).then((result) => {
            if (result) {
                const userInfo = result.data;
                this.setData({
                    userInfo,
                });
                wx.setStorageSync("userInfo", userInfo);
            }
        });
    },
    preparePayInfo: function () {
        const reqParams = {};
        const { userInfo, payInfo } = this.data;
        console.log(userInfo.vipType);
        console.log(payInfo);
        switch (userInfo.vipType) {
            case "bronze":
                if (payInfo.vipType === "bronze") {
                    reqParams.payType = "renew";
                }
                else {
                    reqParams.payType = "upgrade";
                }
                reqParams.period = payInfo.name;
                reqParams.vipType = payInfo.vipType;
                break;
            case "platinum":
                reqParams.payType = "renew";
                reqParams.period = payInfo.name;
                reqParams.vipType = "platinum";
                break;
            default:
                reqParams.payType = "join";
                reqParams.period = payInfo.name;
                reqParams.vipType = payInfo.vipType;
                break;
        }
        return reqParams;
    },
    onReady: function () { },
    onShow: function () { },
    onHide: function () { },
    onUnload: function () { },
    onPullDownRefresh: function () { },
    onReachBottom: function () { },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hvb3NlUGF5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hvb3NlUGF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0RBQW9EO0FBRXBELElBQUksQ0FBQztJQUlILElBQUksRUFBRTtRQUNKLE9BQU8sRUFBRSxFQUFTO1FBQ2xCLFFBQVEsRUFBRSxFQUFTO1FBQ25CLFFBQVEsRUFBRTtZQUNSO2dCQUNFLEtBQUssRUFBRSxJQUFJO2dCQUNYLElBQUksRUFBRSxNQUFNO2dCQUNaLFFBQVEsRUFBRSxJQUFJO2dCQUNkLE9BQU8sRUFBRSxFQUFFO2dCQUNYLE9BQU8sRUFBRSxJQUFJO2FBQ2Q7WUFDRDtnQkFDRSxLQUFLLEVBQUUsS0FBSztnQkFDWixJQUFJLEVBQUUsT0FBTztnQkFDYixRQUFRLEVBQUUsZUFBZTtnQkFDekIsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsT0FBTyxFQUFFLEtBQUs7YUFDZjtTQUNGO1FBQ0QsVUFBVSxFQUFFLElBQUk7S0FDakI7SUFFRCxNQUFNLEVBQUUsVUFBVSxPQUFZO1FBQzVCLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDM0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDbEMsUUFBUSxDQUFDLENBQUMsQ0FBQyxxQkFDTixRQUFRLENBQUMsQ0FBQyxDQUFDLElBQ2QsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUN4QixDQUFDO1FBQ0YsSUFBSSxDQUFDLE9BQVEsQ0FBQztZQUNaLFFBQVEsb0JBQ0gsSUFBSSxDQUNSO1lBQ0QsUUFBUTtTQUNULENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3RDLElBQUksT0FBTyxDQUFDLE9B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QkFDcEMsTUFBTTtZQUVSLEtBQUssVUFBVTtnQkFDYixTQUFTLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztnQkFDNUIsU0FBUyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNoQyxTQUFTLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQztnQkFDL0IsTUFBTTtZQUNSO2dCQUNFLFNBQVMsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO2dCQUMzQixTQUFTLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ2hDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztnQkFDcEMsTUFBTTtTQUNUO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVELE9BQU8sRUFBRSxjQUFhLENBQUM7SUFFdkIsTUFBTSxFQUFFLGNBQWEsQ0FBQztJQUV0QixNQUFNLEVBQUUsY0FBYSxDQUFDO0lBRXRCLFFBQVEsRUFBRSxjQUFhLENBQUM7SUFFeEIsaUJBQWlCLEVBQUUsY0FBYSxDQUFDO0lBRWpDLGFBQWEsRUFBRSxjQUFhLENBQUM7Q0FDOUIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gcGFja2FnZU15aG9tZS9wYWdlcy9jaG9vc2VQYXkuanNcbmltcG9ydCAqIGFzIEFwaSBmcm9tIFwiLi4vLi4vLi4vc2VydmljZS9hcGkuc2VydmljZVwiO1xuXG5QYWdlKHtcbiAgLyoqXG4gICAqIFBhZ2UgaW5pdGlhbCBkYXRhXG4gICAqL1xuICBkYXRhOiB7XG4gICAgcGF5SW5mbzoge30gYXMgYW55LFxuICAgIHVzZXJJbmZvOiB7fSBhcyBhbnksXG4gICAgcGF5SXRlbXM6IFtcbiAgICAgIHtcbiAgICAgICAgdmFsdWU6IFwid3hcIixcbiAgICAgICAgbmFtZTogXCLlvq7kv6HmlK/ku5hcIixcbiAgICAgICAgaWNvbk5hbWU6IFwid3hcIixcbiAgICAgICAgYmFsYW5jZTogXCJcIixcbiAgICAgICAgY2hlY2tlZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHZhbHVlOiBcInlmYlwiLFxuICAgICAgICBuYW1lOiBcIue8mOWIhuW4geaUr+S7mFwiLFxuICAgICAgICBpY29uTmFtZTogXCJtb25leVJlY2hhcmdlXCIsXG4gICAgICAgIGJhbGFuY2U6IDgwLFxuICAgICAgICBjaGVja2VkOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgXSxcbiAgICBzaG9vc2VUeXBlOiBcInd4XCIsXG4gIH0sXG5cbiAgb25Mb2FkOiBmdW5jdGlvbiAob3B0aW9uczogYW55KSB7XG4gICAgY29uc3QgdXNlciA9IHd4LmdldFN0b3JhZ2VTeW5jKFwidXNlckluZm9cIik7XG4gICAgY29uc29sZS5sb2coXCJ1c2VySW5mb1wiLCB1c2VyKTtcbiAgICBsZXQgcGF5SXRlbXMgPSB0aGlzLmRhdGEucGF5SXRlbXM7XG4gICAgcGF5SXRlbXNbMV0gPSB7XG4gICAgICAuLi5wYXlJdGVtc1sxXSxcbiAgICAgIGJhbGFuY2U6IHVzZXIuY29pbiB8fCAwLFxuICAgIH07XG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICB1c2VySW5mbzoge1xuICAgICAgICAuLi51c2VyLFxuICAgICAgfSxcbiAgICAgIHBheUl0ZW1zLFxuICAgIH0pO1xuICAgIGNvbnNvbGUubG9nKGA9PT1vcHRpb25zPT09YCwgb3B0aW9ucyk7XG4gICAgaWYgKG9wdGlvbnMucGF5SW5mbykge1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIHBheUluZm86IEpTT04ucGFyc2Uob3B0aW9ucy5wYXlJbmZvKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcblxuICByYWRpb0NoYW5nZShlOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZyhcInJhZGlv5Y+R55SfY2hhbmdl5LqL5Lu277yM6YCJ5oup55qE5pSv5LuY5pa55byP5Li677yaXCIsIGUuZGV0YWlsLnZhbHVlKTtcblxuICAgIGNvbnN0IHBheUl0ZW1zID0gdGhpcy5kYXRhLnBheUl0ZW1zO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwYXlJdGVtcy5sZW5ndGg7IGkgPCBsZW47ICsraSkge1xuICAgICAgcGF5SXRlbXNbaV0uY2hlY2tlZCA9IHBheUl0ZW1zW2ldLnZhbHVlID09PSBlLmRldGFpbC52YWx1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgIHBheUl0ZW1zLFxuICAgICAgc2hvb3NlVHlwZTogZS5kZXRhaWwudmFsdWUsXG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqIOeri+WNs+aUr+S7mCAqL1xuICBnb1BheSgpIHtcbiAgICBjb25zdCB7IHBheUluZm8sIHNob29zZVR5cGUsIHVzZXJJbmZvIH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc3QgY29pbiA9IHVzZXJJbmZvLmNvaW4gfHwgMDtcbiAgICBjb25zb2xlLmxvZyhgcGF5SW5mbywgc2hvb3NlVHlwZWAsIHNob29zZVR5cGUpO1xuXG4gICAgLy8gVE9ETyDojrflj5bnlKjmiLflvZPliY3nvJjliIbluIHkvZnpop1cbiAgICBpZiAoc2hvb3NlVHlwZSA9PT0gXCJ5ZmJcIiAmJiBjb2luIDwgcGF5SW5mby52YWx1ZSkge1xuICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgdGl0bGU6IFwi5L2Z6aKd5LiN6LazXCIsXG4gICAgICAgIGljb246IFwibm9uZVwiLFxuICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIOe8mOWIhuW4geaUr+S7mFxuICAgIGlmIChzaG9vc2VUeXBlID09PSBcInlmYlwiICYmIHBheUluZm8uY3VycmVudFByaWNlKSB7XG4gICAgICB0aGlzLmNvaW5QYXkoKTtcbiAgICB9IGVsc2UgaWYgKHNob29zZVR5cGUgPT09IFwid3hcIiAmJiBwYXlJbmZvLmN1cnJlbnRQcmljZSkge1xuICAgICAgdGhpcy53eFBheSgpO1xuICAgIH1cblxuICAgIC8vIOW+ruS/oeaUr+S7mFxuXG4gICAgY29uc29sZS5sb2coXCLmoLnmja7mlK/ku5jmlrnlvI/osIPnlKjmjqXlj6NcIik7XG4gIH0sXG5cbiAgLy8g57yY5YiG5biB5pSv5LuYXG4gIGNvaW5QYXk6IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgdGhhdCA9IHRoaXM7XG4gICAgY29uc3QgcmVxUGFyYW1zID0gdGhpcy5wcmVwYXJlUGF5SW5mbygpO1xuICAgIGNvbnNvbGUubG9nKGAtLS0tLXJlcVBhcmFtcy0tLS0tYCwgcmVxUGFyYW1zKTtcbiAgICBBcGkuYnV5VmlwQnlDb2luKHJlcVBhcmFtcykudGhlbigocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5jb2RlID09PSAyMDApIHtcbiAgICAgICAgY29uc29sZS5sb2coYGNvaW4gcGF55LuY5qy+57uT5p2fY29tcGxldGU6IGAsIHJlc3VsdCk7XG4gICAgICAgIHRoYXQucmVxdWVzdEZvclVzZXJJbmZvKCk7XG4gICAgICAgIC8vIOi3s+i9rOiuouWNleivpuaDhVxuICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICB1cmw6IGAuLi9wYXlTdWNjZXNzL3BheVN1Y2Nlc3NgLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICAvLyDliKTmlq3lvZPliY3mmK/lkKbmmK/lvIDpgJrnirbmgIFcbiAgd3hQYXk6IGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCByZXFQYXJhbXMgPSB0aGlzLnByZXBhcmVQYXlJbmZvKCk7XG4gICAgQXBpLmJ1eVZpcEJ5V2VjaGF0KHJlcVBhcmFtcykudGhlbigocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5jb2RlID09PSAyMDApIHtcbiAgICAgICAgbGV0IGRhdGEgPSByZXN1bHQuZGF0YTtcbiAgICAgICAgdGhpcy5jYWxsV3hGb3JQYXkoZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc29sZS5sb2coXCJ3eFBheVwiKTtcbiAgfSxcblxuICBjYWxsV3hGb3JQYXk6IGZ1bmN0aW9uIChkYXRhOiBhbnkpIHtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICB3eC5yZXF1ZXN0UGF5bWVudCh7XG4gICAgICB0aW1lU3RhbXA6IGRhdGEudGltZVN0YW1wLFxuICAgICAgbm9uY2VTdHI6IGRhdGEubm9uY2VTdHIsXG4gICAgICAvLyBwYWNrYWdlOiBkYXRhLnBhY2thZ2UsXG4gICAgICBwYWNrYWdlOiBcInByZXBheV9pZD1cIiArIGRhdGEucHJlcGF5SWQsXG4gICAgICBzaWduVHlwZTogXCJNRDVcIixcbiAgICAgIHBheVNpZ246IGRhdGEucGF5U2lnbixcbiAgICAgIHN1Y2Nlc3MocmVzOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5sb2coYOS7mOasvuaIkOWKnzogYCwgcmVzKTtcbiAgICAgIH0sXG4gICAgICBmYWlsKHJlczogYW55KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDku5jmrL7lpLHotKU6IGAsIHJlcyk7XG4gICAgICB9LFxuICAgICAgY29tcGxldGUocmVzOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5sb2coYOS7mOasvue7k+adn2NvbXBsZXRlOiBgLCByZXMpO1xuICAgICAgICAvLyDku5jmrL7miJDlip/nm7TmjqXmm7TmlrBcbiAgICAgICAgQXBpLmNoZWNrT3JkZXJTdGF0dXMoZGF0YS5vcmRlck51bSkudGhlbigocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5jb2RlID09PSAyMDApIHtcbiAgICAgICAgICAgIHRoYXQucmVxdWVzdEZvclVzZXJJbmZvKCk7XG4gICAgICAgICAgICAvLyDot7PovazorqLljZXor6bmg4VcbiAgICAgICAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICAgICAgICB1cmw6IGAuLi9wYXlTdWNjZXNzL3BheVN1Y2Nlc3NgLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0sXG5cbiAgcmVxdWVzdEZvclVzZXJJbmZvKCkge1xuICAgIEFwaS5nZXRVc2VySW5mbyh0aGlzLmRhdGEudXNlckluZm8ub3BlbmlkKS50aGVuKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBjb25zdCB1c2VySW5mbyA9IHJlc3VsdC5kYXRhO1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICB1c2VySW5mbyxcbiAgICAgICAgfSk7XG4gICAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKFwidXNlckluZm9cIiwgdXNlckluZm8pO1xuICAgICAgfVxuICAgIH0pO1xuICB9LFxuXG4gIC8qKlxuICAgKiB7XG4gIC8vIOmAieaLqeW5tOS7mCwg5pyI5LuYLCDlraPku5hcbiAgXCJwZXJpb2RcIjogXCJtb250aFwiLCAvLyBcIm1vbnRoXCIt5pyIIFwic2Vhc29uXCIt5a2j5bqmIFwieWVhclwiLeW5tFxuICAvLyDkvJrlkZjnsbvlnosgXG4gIFwidmlwVHlwZVwiOiBcImJyb256ZVwiLCAvLyBcImJyb256ZVwiLem7hOmTnCBcInBsYXRpbnVtXCIt55m96YeRIFxuICAvLyDku5jmrL7nsbvlnotcbiAgXCJwYXlUeXBlXCI6IFwiam9pblwiIC8vIFwiam9pblwiLeWKoOWFpSBcInJlbmV3XCIt57ut6LS5IFwidXBncmFkZVwiLeWNh+e6p1xufVxuICAgKiBcbiAgKi9cbiAgcHJlcGFyZVBheUluZm86IGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCByZXFQYXJhbXM6IGFueSA9IHt9O1xuICAgIGNvbnN0IHsgdXNlckluZm8sIHBheUluZm8gfSA9IHRoaXMuZGF0YTtcbiAgICBjb25zb2xlLmxvZyh1c2VySW5mby52aXBUeXBlKTtcbiAgICBjb25zb2xlLmxvZyhwYXlJbmZvKTtcbiAgICBzd2l0Y2ggKHVzZXJJbmZvLnZpcFR5cGUpIHtcbiAgICAgIC8vIOm7hOmTnFxuICAgICAgY2FzZSBcImJyb256ZVwiOlxuICAgICAgICBpZiAocGF5SW5mby52aXBUeXBlID09PSBcImJyb256ZVwiKSB7XG4gICAgICAgICAgLy/nu63otLlcbiAgICAgICAgICByZXFQYXJhbXMucGF5VHlwZSA9IFwicmVuZXdcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXFQYXJhbXMucGF5VHlwZSA9IFwidXBncmFkZVwiO1xuICAgICAgICB9XG4gICAgICAgIHJlcVBhcmFtcy5wZXJpb2QgPSBwYXlJbmZvLm5hbWU7XG4gICAgICAgIHJlcVBhcmFtcy52aXBUeXBlID0gcGF5SW5mby52aXBUeXBlO1xuICAgICAgICBicmVhaztcbiAgICAgIC8vIOeZvemHkVxuICAgICAgY2FzZSBcInBsYXRpbnVtXCI6XG4gICAgICAgIHJlcVBhcmFtcy5wYXlUeXBlID0gXCJyZW5ld1wiO1xuICAgICAgICByZXFQYXJhbXMucGVyaW9kID0gcGF5SW5mby5uYW1lO1xuICAgICAgICByZXFQYXJhbXMudmlwVHlwZSA9IFwicGxhdGludW1cIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXFQYXJhbXMucGF5VHlwZSA9IFwiam9pblwiO1xuICAgICAgICByZXFQYXJhbXMucGVyaW9kID0gcGF5SW5mby5uYW1lO1xuICAgICAgICByZXFQYXJhbXMudmlwVHlwZSA9IHBheUluZm8udmlwVHlwZTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHJldHVybiByZXFQYXJhbXM7XG4gIH0sXG5cbiAgb25SZWFkeTogZnVuY3Rpb24gKCkge30sXG5cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7fSxcblxuICBvbkhpZGU6IGZ1bmN0aW9uICgpIHt9LFxuXG4gIG9uVW5sb2FkOiBmdW5jdGlvbiAoKSB7fSxcblxuICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCkge30sXG5cbiAgb25SZWFjaEJvdHRvbTogZnVuY3Rpb24gKCkge30sXG59KTtcbiJdfQ==